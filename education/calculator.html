<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ultra Scientific Calculator</title>
    <link rel="stylesheet" href="../css/lock.css" />
    <style>
      :root {
        --bg: #0c1118;
        --bg-secondary: #141b24;
        --panel: rgba(18, 24, 34, 0.85);
        --panel-border: rgba(255, 255, 255, 0.08);
        --text: #e8eef7;
        --muted: #8fa2b6;
        --accent: #4f9cf7;
        --accent-strong: #7bb5ff;
        --button: rgba(255, 255, 255, 0.06);
        --button-hover: rgba(255, 255, 255, 0.12);
        --danger: #ff6b6b;
        --glow: 0 0 24px rgba(79, 156, 247, 0.35);
        --radius: 18px;
        --blur: 22px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Space Grotesk", "Segoe UI", sans-serif;
        color: var(--text);
        background:
          radial-gradient(800px 500px at 10% 10%, rgba(89, 132, 255, 0.25), transparent 60%),
          radial-gradient(900px 600px at 90% 15%, rgba(255, 121, 198, 0.2), transparent 62%),
          radial-gradient(600px 500px at 50% 85%, rgba(79, 247, 210, 0.2), transparent 65%),
          linear-gradient(160deg, #0a0f17 0%, #0f1622 40%, #0a1018 100%);
        transition: background 400ms ease;
        overflow-x: hidden;
      }

      #number-field {
        position: fixed;
        inset: 0;
        z-index: 1;
        pointer-events: none;
        overflow: hidden;
      }

      .shell {
        max-width: 1400px;
        margin: 0 auto;
        padding: 28px 18px 32px;
        display: grid;
        gap: 20px;
        min-height: 100vh;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
      }

      .title-block {
        display: grid;
        gap: 6px;
      }

      .eyebrow {
        font-size: 0.68rem;
        letter-spacing: 0.35em;
        text-transform: uppercase;
        color: var(--muted);
      }

      h1 {
        font-size: clamp(2rem, 3vw, 2.6rem);
        margin: 0;
      }

      .subtitle {
        color: var(--muted);
        margin: 0;
        max-width: 60ch;
      }

      .layout {
        position: relative;
        display: grid;
        grid-template-columns: minmax(220px, 260px) minmax(0, 1fr);
        gap: 22px;
        min-height: calc(100vh - 140px);
        padding-right: 320px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--panel-border);
        border-radius: var(--radius);
        padding: 18px;
        backdrop-filter: blur(var(--blur));
        box-shadow: 0 20px 50px rgba(5, 10, 18, 0.45);
        position: relative;
        z-index: 2;
      }

      .calculator-panel {
        height: 100%;
      }

      .calculator-panel::before {
        content: "";
        position: absolute;
        inset: -20px;
        border-radius: 26px;
        background: radial-gradient(circle, var(--display-accent-1, rgba(79, 156, 247, 0.25)) 0%, transparent 65%);
        opacity: 0.35;
        pointer-events: none;
        z-index: -1;
        filter: blur(8px);
      }

      .panel::after {
        content: "";
        position: absolute;
        inset: 10px;
        border-radius: calc(var(--radius) - 6px);
        background: var(--theme-overlay, none);
        opacity: var(--theme-overlay-opacity, 0);
        pointer-events: none;
        z-index: 0;
        mix-blend-mode: screen;
      }

      .panel > * {
        position: relative;
        z-index: 1;
      }

      .display {
        display: grid;
        gap: 12px;
      }

      .display-screen {
        min-height: 110px;
        padding: 16px;
        border-radius: 16px;
        background: rgba(9, 13, 20, 0.75);
        border: 1px solid rgba(255, 255, 255, 0.08);
        display: grid;
        gap: 8px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 0 24px rgba(79, 156, 247, 0.15);
      }

      .display-screen::after {
        content: "";
        position: absolute;
        inset: -40%;
        background: radial-gradient(circle, var(--display-accent-1, rgba(79, 156, 247, 0.3)) 0%, transparent 55%),
          radial-gradient(circle, var(--display-accent-2, rgba(97, 222, 255, 0.3)) 0%, transparent 60%);
        opacity: 0.7;
        animation: displayGlow 6s linear infinite;
        pointer-events: none;
        mix-blend-mode: screen;
      }

      @keyframes displayGlow {
        0% {
          transform: translate(-10%, -10%) rotate(0deg);
        }
        100% {
          transform: translate(10%, 10%) rotate(360deg);
        }
      }

      .display-screen .expression {
        min-height: 24px;
        font-size: 0.95rem;
        color: var(--muted);
        word-break: break-word;
        position: relative;
        z-index: 1;
      }

      .display-screen .result {
        font-size: clamp(1.8rem, 3vw, 2.6rem);
        font-weight: 600;
        word-break: break-word;
        position: relative;
        z-index: 1;
      }

      .mode-strip {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .mode-pill {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: var(--muted);
      }

      .keypad {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
      }

      .btn {
        border: none;
        border-radius: 14px;
        padding: 14px 12px;
        font-size: 1rem;
        color: var(--text);
        background: var(--button);
        cursor: pointer;
        transition: transform 120ms ease, background 200ms ease, box-shadow 200ms ease;
        position: relative;
        overflow: hidden;
      }

      .btn:hover,
      .btn:focus-visible {
        background: var(--button-hover);
        transform: translateY(-1px);
      }

      .btn:active {
        transform: translateY(1px) scale(0.98);
      }

      .btn-operator {
        color: var(--accent-strong);
      }

      .btn-active {
        box-shadow: 0 0 18px rgba(255, 255, 255, 0.25);
        background: var(--button-hover);
      }

      .btn-equals {
        background: var(--accent);
        color: #0b1220;
        font-weight: 700;
        box-shadow: var(--glow);
        grid-column: span 2;
      }

      .btn-clear {
        color: var(--danger);
      }

      .btn-wide {
        grid-column: span 2;
      }

      .scientific {
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 10px;
        margin-top: 14px;
      }

      .memory-keys {
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 10px;
        margin-top: 12px;
      }

      .settings-toggle {
        border: none;
        border-radius: 999px;
        padding: 10px 16px;
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        font-size: 0.8rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        cursor: pointer;
        transition: transform 150ms ease, background 200ms ease;
      }

      .settings-toggle:hover,
      .settings-toggle:focus-visible {
        background: rgba(255, 255, 255, 0.16);
        transform: translateY(-1px);
      }

      .settings-shell {
        position: absolute;
        top: 0;
        right: 0;
        width: 300px;
        perspective: 1200px;
        min-height: 360px;
      }

      .memory-panel {
        display: grid;
        gap: 14px;
        align-content: start;
      }

      .memory-panel h2 {
        margin: 0;
        font-size: 1.1rem;
      }

      .memory-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .memory-count {
        font-size: 0.75rem;
        color: var(--muted);
      }

      .memory-list {
        display: grid;
        gap: 8px;
        max-height: 520px;
        overflow-y: auto;
        padding-right: 6px;
      }

      .memory-item {
        background: rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 0.9rem;
        color: var(--text);
        cursor: pointer;
        transition: background 150ms ease;
        border: 1px solid rgba(255, 255, 255, 0.08);
        word-break: break-word;
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 10px;
      }

      .memory-item:hover,
      .memory-item:focus-visible {
        background: rgba(255, 255, 255, 0.12);
      }

      .memory-empty {
        color: var(--muted);
        font-size: 0.85rem;
        line-height: 1.4;
      }

      .memory-delete {
        border: none;
        background: rgba(255, 255, 255, 0.1);
        color: var(--text);
        border-radius: 999px;
        width: 26px;
        height: 26px;
        cursor: pointer;
      }

      .tutorial-overlay {
        position: fixed;
        inset: 0;
        background: rgba(6, 10, 16, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 24px;
      }

      .tutorial-card {
        max-width: 520px;
        width: min(520px, 92vw);
        background: rgba(12, 18, 28, 0.96);
        border-radius: 18px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        display: grid;
        gap: 12px;
      }

      .tutorial-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        flex-wrap: wrap;
      }

      .memory-delete {
        border: none;
        background: rgba(255, 255, 255, 0.1);
        color: var(--text);
        border-radius: 999px;
        width: 26px;
        height: 26px;
        cursor: pointer;
      }

      .tutorial-overlay {
        position: fixed;
        inset: 0;
        background: rgba(6, 10, 16, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 24px;
      }

      .tutorial-card {
        max-width: 520px;
        width: min(520px, 92vw);
        background: rgba(12, 18, 28, 0.96);
        border-radius: 18px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        display: grid;
        gap: 12px;
      }

      .tutorial-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        flex-wrap: wrap;
      }

      .settings-card {
        position: relative;
        width: 100%;
        min-height: 360px;
        transform-style: preserve-3d;
        transition: transform 0.7s ease;
      }

      .settings-shell.is-open .settings-card {
        transform: rotateY(180deg);
      }

      .settings-face {
        position: absolute;
        inset: 0;
        backface-visibility: hidden;
      }

      .settings-front {
        display: grid;
        gap: 14px;
        align-content: center;
        text-align: center;
      }

      .settings-front .settings-icon {
        font-size: 2.2rem;
        letter-spacing: 0.1em;
      }

      .settings-back {
        transform: rotateY(180deg);
      }

      .settings {
        display: grid;
        gap: 14px;
      }

      .settings h2 {
        margin: 0;
        font-size: 1.1rem;
      }

      .setting-group {
        display: grid;
        gap: 8px;
      }

      .setting-group label {
        font-size: 0.85rem;
        color: var(--muted);
      }

      select,
      input[type="checkbox"] {
        accent-color: var(--accent);
      }

      select {
        background: rgba(9, 13, 20, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        font-size: 0.95rem;
      }

      .toggle {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .legend {
        font-size: 0.8rem;
        color: var(--muted);
      }

      .pulse {
        animation: pulse 0.6s ease;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 rgba(255, 255, 255, 0.15);
        }
        50% {
          box-shadow: 0 0 28px rgba(255, 255, 255, 0.4);
        }
        100% {
          box-shadow: 0 0 0 rgba(255, 255, 255, 0.15);
        }
      }

      .dynamic-splash {
        position: absolute;
        width: 140px;
        height: 140px;
        border-radius: 50%;
        pointer-events: none;
        mix-blend-mode: screen;
        opacity: 0.7;
        animation: splash 0.7s ease forwards;
        filter: blur(2px);
      }

      @keyframes splash {
        0% {
          transform: scale(0.2);
          opacity: 0.8;
        }
        80% {
          opacity: 0.5;
        }
        100% {
          transform: scale(1.2);
          opacity: 0;
        }
      }

      .rainbow-mode .btn,
      .rainbow-mode .btn-equals {
        background: linear-gradient(120deg, rgba(255, 94, 98, 0.8), rgba(255, 195, 113, 0.75), rgba(111, 237, 153, 0.75), rgba(78, 156, 255, 0.75), rgba(178, 94, 255, 0.8));
        color: #0b0f14;
      }

      .rainbow-mode .panel {
        border-color: rgba(255, 255, 255, 0.2);
      }

      .leaf-mode {
        --bg: #ecf7f1;
        --bg-secondary: #dcefe4;
        --panel: rgba(241, 250, 244, 0.9);
        --panel-border: rgba(84, 128, 97, 0.2);
        --text: #0d2016;
        --muted: #3f5f4c;
        --accent: #4e8f64;
        --accent-strong: #77b686;
        --button: rgba(78, 143, 100, 0.18);
        --button-hover: rgba(78, 143, 100, 0.28);
        --glow: 0 0 24px rgba(78, 143, 100, 0.35);
        --theme-overlay:
          radial-gradient(160px 120px at 18% 20%, rgba(119, 182, 134, 0.35), transparent 70%),
          radial-gradient(220px 160px at 80% 70%, rgba(78, 143, 100, 0.28), transparent 75%),
          repeating-linear-gradient(140deg, rgba(255, 255, 255, 0.18) 0 6px, transparent 6px 16px);
        --theme-overlay-opacity: 0.5;
      }

      .leaf-mode body,
      body.leaf-mode {
        background:
          radial-gradient(900px 600px at 15% 10%, rgba(145, 209, 170, 0.6), transparent 60%),
          radial-gradient(700px 500px at 80% 20%, rgba(116, 172, 143, 0.5), transparent 62%),
          linear-gradient(180deg, #f5fbf7 0%, #e1f0e7 50%, #d5e8dd 100%);
      }

      .satisfying-mode {
        --accent: #51d6c9;
        --accent-strong: #7ff3e8;
        --button: rgba(81, 214, 201, 0.2);
        --button-hover: rgba(81, 214, 201, 0.3);
        --display-accent-1: rgba(81, 214, 201, 0.45);
        --display-accent-2: rgba(127, 243, 232, 0.4);
        --theme-overlay:
          radial-gradient(220px 180px at 20% 30%, rgba(81, 214, 201, 0.28), transparent 70%),
          radial-gradient(200px 160px at 85% 75%, rgba(127, 243, 232, 0.24), transparent 72%);
        --theme-overlay-opacity: 0.4;
      }

      .ultra-satisfying {
        --accent: #ffd166;
        --accent-strong: #ffe59a;
        --button: rgba(255, 209, 102, 0.25);
        --button-hover: rgba(255, 209, 102, 0.4);
        --glow: 0 0 30px rgba(255, 209, 102, 0.5);
        --display-accent-1: rgba(255, 209, 102, 0.5);
        --display-accent-2: rgba(255, 229, 154, 0.45);
        --theme-overlay:
          repeating-linear-gradient(120deg, rgba(255, 255, 255, 0.24) 0 8px, transparent 8px 18px),
          radial-gradient(200px 140px at 75% 25%, rgba(255, 229, 154, 0.28), transparent 70%);
        --theme-overlay-opacity: 0.45;
      }

      .ultra-unsatisfying {
        --accent: #ff8fab;
        --accent-strong: #ffc8dd;
        --button: rgba(255, 143, 171, 0.14);
        --button-hover: rgba(255, 143, 171, 0.2);
        --glow: 0 0 10px rgba(255, 143, 171, 0.2);
        --display-accent-1: rgba(255, 143, 171, 0.35);
        --display-accent-2: rgba(255, 200, 221, 0.3);
        --theme-overlay:
          repeating-linear-gradient(45deg, rgba(255, 143, 171, 0.2) 0 4px, transparent 4px 12px),
          repeating-linear-gradient(-45deg, rgba(255, 200, 221, 0.15) 0 6px, transparent 6px 14px);
        --theme-overlay-opacity: 0.35;
      }

      .rainbow-mode body,
      body.rainbow-mode {
        background:
          conic-gradient(from 120deg at 50% 50%, rgba(255, 94, 98, 0.45), rgba(255, 195, 113, 0.4), rgba(111, 237, 153, 0.35), rgba(78, 156, 255, 0.35), rgba(178, 94, 255, 0.4), rgba(255, 94, 98, 0.45));
        animation: rainbowShift 12s linear infinite;
      }

      .aurora-mode {
        --accent: #7ce7f2;
        --accent-strong: #b6f5ff;
        --button: rgba(124, 231, 242, 0.2);
        --button-hover: rgba(124, 231, 242, 0.32);
        --glow: 0 0 26px rgba(124, 231, 242, 0.45);
        --display-accent-1: rgba(124, 231, 242, 0.5);
        --display-accent-2: rgba(182, 245, 255, 0.35);
        --theme-overlay:
          linear-gradient(120deg, rgba(124, 231, 242, 0.35), transparent 55%),
          linear-gradient(300deg, rgba(138, 99, 255, 0.25), transparent 60%);
        --theme-overlay-opacity: 0.45;
      }

      body.aurora-mode {
        background:
          radial-gradient(900px 600px at 20% 15%, rgba(124, 231, 242, 0.35), transparent 60%),
          radial-gradient(700px 500px at 80% 25%, rgba(138, 99, 255, 0.25), transparent 62%),
          linear-gradient(160deg, #0a1018 0%, #111c2a 55%, #0a111b 100%);
      }

      .midnight-mode {
        --accent: #8aa6ff;
        --accent-strong: #b7c8ff;
        --button: rgba(138, 166, 255, 0.18);
        --button-hover: rgba(138, 166, 255, 0.28);
        --display-accent-1: rgba(138, 166, 255, 0.45);
        --display-accent-2: rgba(183, 200, 255, 0.35);
        --theme-overlay:
          radial-gradient(2px 2px at 10% 20%, rgba(255, 255, 255, 0.6), transparent 60%),
          radial-gradient(2px 2px at 80% 30%, rgba(255, 255, 255, 0.4), transparent 60%),
          radial-gradient(2px 2px at 65% 70%, rgba(255, 255, 255, 0.5), transparent 60%),
          radial-gradient(2px 2px at 25% 75%, rgba(255, 255, 255, 0.35), transparent 60%);
        --theme-overlay-opacity: 0.35;
      }

      .solar-mode {
        --accent: #ffb703;
        --accent-strong: #ffd166;
        --button: rgba(255, 183, 3, 0.22);
        --button-hover: rgba(255, 183, 3, 0.35);
        --display-accent-1: rgba(255, 183, 3, 0.5);
        --display-accent-2: rgba(255, 209, 102, 0.4);
        --theme-overlay:
          conic-gradient(from 200deg at 30% 30%, rgba(255, 209, 102, 0.5), transparent 30%, rgba(255, 183, 3, 0.3) 60%, transparent 80%),
          radial-gradient(260px 180px at 75% 70%, rgba(255, 209, 102, 0.35), transparent 70%);
        --theme-overlay-opacity: 0.45;
      }

      .graphite-mode {
        --accent: #cbd5e1;
        --accent-strong: #f1f5f9;
        --button: rgba(148, 163, 184, 0.22);
        --button-hover: rgba(148, 163, 184, 0.34);
        --panel: rgba(15, 23, 42, 0.8);
        --display-accent-1: rgba(203, 213, 225, 0.35);
        --display-accent-2: rgba(241, 245, 249, 0.3);
        --theme-overlay:
          repeating-linear-gradient(110deg, rgba(255, 255, 255, 0.08) 0 2px, transparent 2px 10px),
          repeating-linear-gradient(200deg, rgba(255, 255, 255, 0.06) 0 1px, transparent 1px 8px);
        --theme-overlay-opacity: 0.35;
      }

      .candy-mode {
        --accent: #ff7ecb;
        --accent-strong: #ffd1ea;
        --button: rgba(255, 126, 203, 0.2);
        --button-hover: rgba(255, 126, 203, 0.32);
        --display-accent-1: rgba(255, 126, 203, 0.45);
        --display-accent-2: rgba(255, 209, 234, 0.35);
        --theme-overlay:
          radial-gradient(6px 6px at 15% 25%, rgba(255, 255, 255, 0.6), transparent 60%),
          radial-gradient(6px 6px at 35% 70%, rgba(255, 209, 234, 0.7), transparent 60%),
          radial-gradient(5px 5px at 70% 40%, rgba(255, 255, 255, 0.55), transparent 60%),
          radial-gradient(5px 5px at 85% 75%, rgba(255, 209, 234, 0.6), transparent 60%);
        --theme-overlay-opacity: 0.5;
      }

      .glacier-mode {
        --accent: #7dd3fc;
        --accent-strong: #bae6fd;
        --button: rgba(125, 211, 252, 0.2);
        --button-hover: rgba(125, 211, 252, 0.3);
        --display-accent-1: rgba(125, 211, 252, 0.45);
        --display-accent-2: rgba(186, 230, 253, 0.35);
        --theme-overlay:
          linear-gradient(140deg, rgba(186, 230, 253, 0.3), transparent 55%),
          linear-gradient(320deg, rgba(125, 211, 252, 0.25), transparent 60%);
        --theme-overlay-opacity: 0.4;
      }

      .ember-mode {
        --accent: #ff7a59;
        --accent-strong: #ffb199;
        --button: rgba(255, 122, 89, 0.2);
        --button-hover: rgba(255, 122, 89, 0.32);
        --display-accent-1: rgba(255, 122, 89, 0.45);
        --display-accent-2: rgba(255, 177, 153, 0.35);
        --theme-overlay:
          radial-gradient(3px 3px at 15% 30%, rgba(255, 177, 153, 0.7), transparent 60%),
          radial-gradient(3px 3px at 55% 65%, rgba(255, 122, 89, 0.55), transparent 60%),
          radial-gradient(3px 3px at 80% 40%, rgba(255, 177, 153, 0.6), transparent 60%);
        --theme-overlay-opacity: 0.45;
      }

      .neon-mode {
        --accent: #4ade80;
        --accent-strong: #a7f3d0;
        --button: rgba(74, 222, 128, 0.22);
        --button-hover: rgba(74, 222, 128, 0.36);
        --glow: 0 0 30px rgba(74, 222, 128, 0.5);
        --display-accent-1: rgba(74, 222, 128, 0.5);
        --display-accent-2: rgba(167, 243, 208, 0.35);
        --theme-overlay:
          repeating-linear-gradient(90deg, rgba(74, 222, 128, 0.3) 0 2px, transparent 2px 14px),
          repeating-linear-gradient(0deg, rgba(167, 243, 208, 0.2) 0 1px, transparent 1px 12px);
        --theme-overlay-opacity: 0.4;
      }

      .lavender-mode {
        --accent: #b794f4;
        --accent-strong: #d6bcfa;
        --button: rgba(183, 148, 244, 0.2);
        --button-hover: rgba(183, 148, 244, 0.32);
        --display-accent-1: rgba(183, 148, 244, 0.45);
        --display-accent-2: rgba(214, 188, 250, 0.35);
        --theme-overlay:
          radial-gradient(120px 120px at 25% 25%, rgba(214, 188, 250, 0.35), transparent 70%),
          radial-gradient(140px 140px at 80% 70%, rgba(183, 148, 244, 0.3), transparent 72%);
        --theme-overlay-opacity: 0.4;
      }

      .sand-mode {
        --accent: #f4d35e;
        --accent-strong: #ffe8a3;
        --button: rgba(244, 211, 94, 0.2);
        --button-hover: rgba(244, 211, 94, 0.32);
        --display-accent-1: rgba(244, 211, 94, 0.45);
        --display-accent-2: rgba(255, 232, 163, 0.35);
        --theme-overlay:
          repeating-linear-gradient(160deg, rgba(255, 255, 255, 0.18) 0 2px, transparent 2px 8px),
          radial-gradient(160px 120px at 70% 30%, rgba(255, 232, 163, 0.25), transparent 70%);
        --theme-overlay-opacity: 0.35;
      }

      .ocean-mode {
        --accent: #38bdf8;
        --accent-strong: #7dd3fc;
        --button: rgba(56, 189, 248, 0.2);
        --button-hover: rgba(56, 189, 248, 0.32);
        --display-accent-1: rgba(56, 189, 248, 0.45);
        --display-accent-2: rgba(125, 211, 252, 0.35);
        --theme-overlay:
          repeating-radial-gradient(circle at 20% 30%, rgba(125, 211, 252, 0.25) 0 6px, transparent 6px 20px),
          linear-gradient(120deg, rgba(56, 189, 248, 0.25), transparent 60%);
        --theme-overlay-opacity: 0.4;
      }

      .citrus-mode {
        --accent: #facc15;
        --accent-strong: #fde68a;
        --button: rgba(250, 204, 21, 0.22);
        --button-hover: rgba(250, 204, 21, 0.36);
        --display-accent-1: rgba(250, 204, 21, 0.5);
        --display-accent-2: rgba(253, 230, 138, 0.35);
        --theme-overlay:
          conic-gradient(from 120deg at 30% 30%, rgba(253, 230, 138, 0.45), transparent 40%),
          conic-gradient(from 320deg at 70% 70%, rgba(250, 204, 21, 0.4), transparent 45%);
        --theme-overlay-opacity: 0.45;
      }

      .mono-mode {
        --accent: #f8fafc;
        --accent-strong: #e2e8f0;
        --button: rgba(248, 250, 252, 0.14);
        --button-hover: rgba(248, 250, 252, 0.22);
        --display-accent-1: rgba(248, 250, 252, 0.35);
        --display-accent-2: rgba(226, 232, 240, 0.28);
        --theme-overlay:
          repeating-linear-gradient(90deg, rgba(248, 250, 252, 0.18) 0 1px, transparent 1px 16px),
          repeating-linear-gradient(0deg, rgba(248, 250, 252, 0.16) 0 1px, transparent 1px 16px);
        --theme-overlay-opacity: 0.3;
      }

      .rose-mode {
        --accent: #fb7185;
        --accent-strong: #fecdd3;
        --button: rgba(251, 113, 133, 0.2);
        --button-hover: rgba(251, 113, 133, 0.32);
        --display-accent-1: rgba(251, 113, 133, 0.45);
        --display-accent-2: rgba(254, 205, 211, 0.35);
        --theme-overlay:
          radial-gradient(140px 100px at 30% 25%, rgba(254, 205, 211, 0.35), transparent 70%),
          radial-gradient(160px 120px at 80% 70%, rgba(251, 113, 133, 0.25), transparent 72%);
        --theme-overlay-opacity: 0.4;
      }

      .brass-mode {
        --accent: #d4a373;
        --accent-strong: #edd0b0;
        --button: rgba(212, 163, 115, 0.2);
        --button-hover: rgba(212, 163, 115, 0.32);
        --display-accent-1: rgba(212, 163, 115, 0.45);
        --display-accent-2: rgba(237, 208, 176, 0.35);
        --theme-overlay:
          radial-gradient(6px 6px at 20% 20%, rgba(237, 208, 176, 0.7), transparent 60%),
          radial-gradient(6px 6px at 80% 25%, rgba(237, 208, 176, 0.7), transparent 60%),
          radial-gradient(6px 6px at 25% 80%, rgba(237, 208, 176, 0.7), transparent 60%),
          radial-gradient(6px 6px at 75% 75%, rgba(237, 208, 176, 0.7), transparent 60%);
        --theme-overlay-opacity: 0.4;
      }

      .cyber-mode {
        --accent: #22d3ee;
        --accent-strong: #67e8f9;
        --button: rgba(34, 211, 238, 0.22);
        --button-hover: rgba(34, 211, 238, 0.36);
        --glow: 0 0 32px rgba(34, 211, 238, 0.55);
        --display-accent-1: rgba(34, 211, 238, 0.6);
        --display-accent-2: rgba(103, 232, 249, 0.45);
        --theme-overlay:
          repeating-linear-gradient(90deg, rgba(34, 211, 238, 0.35) 0 2px, transparent 2px 18px),
          repeating-linear-gradient(0deg, rgba(103, 232, 249, 0.25) 0 2px, transparent 2px 18px);
        --theme-overlay-opacity: 0.55;
      }

      .leaf-mode {
        --display-accent-1: rgba(78, 143, 100, 0.45);
        --display-accent-2: rgba(119, 182, 134, 0.35);
      }

      .rainbow-mode {
        --display-accent-1: rgba(255, 94, 98, 0.45);
        --display-accent-2: rgba(78, 156, 255, 0.35);
        --theme-overlay:
          conic-gradient(from 120deg at 40% 40%, rgba(255, 94, 98, 0.35), rgba(255, 195, 113, 0.3), rgba(111, 237, 153, 0.3), rgba(78, 156, 255, 0.3), rgba(178, 94, 255, 0.35), rgba(255, 94, 98, 0.35));
        --theme-overlay-opacity: 0.5;
      }

      .prism-mode {
        --accent: #9be8ff;
        --accent-strong: #e0f7ff;
        --button: rgba(155, 232, 255, 0.18);
        --button-hover: rgba(155, 232, 255, 0.3);
        --panel: rgba(12, 22, 34, 0.8);
        --glow: 0 0 36px rgba(155, 232, 255, 0.45);
        --display-accent-1: rgba(155, 232, 255, 0.6);
        --display-accent-2: rgba(255, 255, 255, 0.35);
        --theme-overlay:
          linear-gradient(120deg, rgba(255, 255, 255, 0.35), transparent 60%),
          linear-gradient(280deg, rgba(120, 200, 255, 0.25), transparent 60%),
          conic-gradient(from 120deg at 70% 30%, rgba(255, 255, 255, 0.25), transparent 35%, rgba(155, 232, 255, 0.25), transparent 70%);
        --theme-overlay-opacity: 0.5;
      }

      body.prism-mode {
        background:
          radial-gradient(900px 600px at 20% 20%, rgba(155, 232, 255, 0.25), transparent 60%),
          radial-gradient(700px 500px at 80% 20%, rgba(96, 165, 250, 0.2), transparent 62%),
          linear-gradient(160deg, #0c141f 0%, #0b111a 60%, #0a0f16 100%);
      }

      .prism-mode .display-screen {
        backdrop-filter: blur(16px);
        border-color: rgba(255, 255, 255, 0.18);
      }

      .prism-mode .btn {
        background: linear-gradient(140deg, rgba(255, 255, 255, 0.22), rgba(155, 232, 255, 0.14));
        border: 1px solid rgba(255, 255, 255, 0.15);
      }

      .prism-mode .panel::after {
        background:
          linear-gradient(120deg, rgba(255, 255, 255, 0.45), transparent 45%),
          linear-gradient(240deg, rgba(155, 232, 255, 0.35), transparent 55%),
          linear-gradient(90deg, rgba(96, 165, 250, 0.3), transparent 60%);
        background-size: 160% 160%;
        animation: prismSheen 8s linear infinite;
      }

      .prism-mode .btn-equals {
        background: linear-gradient(140deg, rgba(155, 232, 255, 0.9), rgba(255, 255, 255, 0.7));
        color: #0b1220;
        text-shadow: 0 0 12px rgba(255, 255, 255, 0.6);
      }

      .noir-mode {
        --accent: #e2e8f0;
        --accent-strong: #f8fafc;
        --button: rgba(255, 255, 255, 0.1);
        --button-hover: rgba(255, 255, 255, 0.2);
        --panel: rgba(8, 10, 12, 0.9);
        --text: #f8fafc;
        --muted: #94a3b8;
        --display-accent-1: rgba(226, 232, 240, 0.35);
        --display-accent-2: rgba(248, 250, 252, 0.25);
        --theme-overlay:
          radial-gradient(400px 300px at 50% 30%, rgba(255, 255, 255, 0.12), transparent 70%),
          radial-gradient(500px 400px at 50% 120%, rgba(0, 0, 0, 0.8), transparent 65%),
          repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.05) 0 1px, transparent 1px 4px);
        --theme-overlay-opacity: 0.6;
      }

      body.noir-mode {
        background:
          radial-gradient(800px 500px at 20% 20%, rgba(30, 41, 59, 0.4), transparent 65%),
          radial-gradient(700px 500px at 80% 20%, rgba(15, 23, 42, 0.5), transparent 65%),
          linear-gradient(180deg, #050608 0%, #0b0f14 60%, #0a0c10 100%);
      }

      .noir-mode .panel::after {
        filter: contrast(1.15);
      }

      .noir-mode .btn {
        border: 1px solid rgba(255, 255, 255, 0.12);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .noir-mode .display-screen::after {
        background:
          radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.2), transparent 55%),
          radial-gradient(circle at 70% 80%, rgba(0, 0, 0, 0.5), transparent 60%);
        animation: noirFlicker 4s ease-in-out infinite;
      }

      .noir-mode .mode-strip {
        background:
          repeating-linear-gradient(90deg, rgba(255, 255, 255, 0.15) 0 6px, transparent 6px 12px);
      }

      .zen-mode {
        --accent: #8fd3c8;
        --accent-strong: #c3f3ea;
        --button: rgba(143, 211, 200, 0.18);
        --button-hover: rgba(143, 211, 200, 0.3);
        --panel: rgba(236, 248, 246, 0.92);
        --text: #0f1b1a;
        --muted: #3f5755;
        --display-accent-1: rgba(143, 211, 200, 0.45);
        --display-accent-2: rgba(195, 243, 234, 0.35);
        --theme-overlay:
          radial-gradient(240px 240px at 75% 35%, rgba(143, 211, 200, 0.25), transparent 70%),
          conic-gradient(from 0deg at 35% 70%, rgba(63, 87, 85, 0.2), transparent 35%, rgba(143, 211, 200, 0.2), transparent 70%);
        --theme-overlay-opacity: 0.5;
      }

      body.zen-mode {
        background:
          radial-gradient(900px 600px at 20% 10%, rgba(186, 230, 253, 0.3), transparent 60%),
          linear-gradient(180deg, #f5fbfa 0%, #e6f2ef 50%, #d7e8e3 100%);
      }

      .zen-mode .btn {
        border-radius: 999px;
        font-style: italic;
        background:
          radial-gradient(120px 60px at 30% 20%, rgba(255, 255, 255, 0.6), transparent 70%),
          linear-gradient(160deg, rgba(143, 211, 200, 0.35), rgba(143, 211, 200, 0.08));
      }

      .zen-mode .calculator-panel::before {
        opacity: 0.6;
        animation: zenPulse 8s ease-in-out infinite;
      }

      .zen-mode .display-screen {
        background:
          radial-gradient(220px 120px at 20% 20%, rgba(255, 255, 255, 0.45), transparent 60%),
          rgba(239, 246, 245, 0.9);
        color: #0f1b1a;
      }

      .magma-mode {
        --accent: #ff6b35;
        --accent-strong: #ffb385;
        --button: rgba(255, 107, 53, 0.22);
        --button-hover: rgba(255, 107, 53, 0.35);
        --panel: rgba(20, 10, 10, 0.88);
        --display-accent-1: rgba(255, 107, 53, 0.55);
        --display-accent-2: rgba(255, 179, 133, 0.4);
        --theme-overlay:
          repeating-linear-gradient(120deg, rgba(255, 107, 53, 0.35) 0 2px, transparent 2px 14px),
          radial-gradient(200px 120px at 20% 80%, rgba(255, 179, 133, 0.3), transparent 70%);
        --theme-overlay-opacity: 0.55;
      }

      body.magma-mode {
        background:
          radial-gradient(700px 500px at 20% 20%, rgba(255, 107, 53, 0.25), transparent 60%),
          radial-gradient(800px 600px at 80% 40%, rgba(251, 146, 60, 0.2), transparent 60%),
          linear-gradient(180deg, #180b0b 0%, #120909 55%, #0b0505 100%);
      }

      .magma-mode .btn-equals {
        background: linear-gradient(140deg, rgba(255, 107, 53, 0.9), rgba(255, 179, 133, 0.65));
        box-shadow: 0 0 18px rgba(255, 107, 53, 0.45);
      }

      .magma-mode .btn {
        box-shadow: inset 0 0 0 1px rgba(255, 107, 53, 0.35);
        animation: magmaGlow 6s ease-in-out infinite;
      }

      .magma-mode .display-screen::after {
        background:
          repeating-linear-gradient(120deg, rgba(255, 179, 133, 0.4) 0 2px, transparent 2px 10px),
          radial-gradient(circle at 20% 80%, rgba(255, 107, 53, 0.45), transparent 60%);
      }

      .circuit-mode {
        --accent: #8bff6c;
        --accent-strong: #d9ffd0;
        --button: rgba(139, 255, 108, 0.18);
        --button-hover: rgba(139, 255, 108, 0.32);
        --panel: rgba(8, 16, 12, 0.88);
        --display-accent-1: rgba(139, 255, 108, 0.55);
        --display-accent-2: rgba(217, 255, 208, 0.35);
        --theme-overlay:
          linear-gradient(90deg, rgba(139, 255, 108, 0.5) 0 2px, transparent 2px) left 20% top 15% / 60px 60px no-repeat,
          linear-gradient(0deg, rgba(139, 255, 108, 0.5) 0 2px, transparent 2px) left 20% top 15% / 60px 60px no-repeat,
          linear-gradient(90deg, rgba(139, 255, 108, 0.5) 0 2px, transparent 2px) right 20% bottom 20% / 60px 60px no-repeat,
          linear-gradient(0deg, rgba(139, 255, 108, 0.5) 0 2px, transparent 2px) right 20% bottom 20% / 60px 60px no-repeat,
          repeating-linear-gradient(90deg, rgba(139, 255, 108, 0.18) 0 2px, transparent 2px 18px),
          repeating-linear-gradient(0deg, rgba(139, 255, 108, 0.14) 0 2px, transparent 2px 18px);
        --theme-overlay-opacity: 0.6;
      }

      body.circuit-mode {
        background:
          radial-gradient(900px 600px at 20% 20%, rgba(139, 255, 108, 0.2), transparent 60%),
          linear-gradient(180deg, #09110c 0%, #0b1410 55%, #070c09 100%);
      }

      .circuit-mode .btn {
        border: 1px solid rgba(139, 255, 108, 0.25);
        text-shadow: 0 0 10px rgba(139, 255, 108, 0.4);
      }

      .circuit-mode .panel::after {
        background-size: 140% 140%;
        animation: circuitScan 10s linear infinite;
      }

      .circuit-mode .display-screen {
        border-color: rgba(139, 255, 108, 0.35);
        box-shadow: 0 0 20px rgba(139, 255, 108, 0.25);
      }

      .paper-mode {
        --accent: #111827;
        --accent-strong: #1f2937;
        --button: rgba(17, 24, 39, 0.08);
        --button-hover: rgba(17, 24, 39, 0.14);
        --panel: rgba(250, 250, 245, 0.96);
        --text: #0f172a;
        --muted: #475569;
        --display-accent-1: rgba(15, 23, 42, 0.25);
        --display-accent-2: rgba(148, 163, 184, 0.25);
        --theme-overlay:
          repeating-linear-gradient(0deg, rgba(148, 163, 184, 0.35) 0 1px, transparent 1px 18px),
          linear-gradient(90deg, rgba(239, 68, 68, 0.4) 0 2px, transparent 2px 100%);
        --theme-overlay-opacity: 0.6;
      }

      body.paper-mode {
        background:
          radial-gradient(900px 600px at 20% 20%, rgba(226, 232, 240, 0.6), transparent 60%),
          linear-gradient(180deg, #fbfbf6 0%, #f1f2ea 60%, #e7e9de 100%);
      }

      .paper-mode .panel::after {
        mix-blend-mode: multiply;
      }

      .paper-mode .btn {
        border: 1px solid rgba(15, 23, 42, 0.2);
        border-radius: 10px;
        font-family: "Courier New", monospace;
      }

      .paper-mode .panel {
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.18);
        animation: paperFloat 6s ease-in-out infinite;
      }

      .paper-mode .display-screen {
        background:
          linear-gradient(0deg, rgba(239, 68, 68, 0.25) 0 2px, transparent 2px),
          repeating-linear-gradient(0deg, rgba(148, 163, 184, 0.2) 0 1px, transparent 1px 18px),
          rgba(250, 250, 245, 0.95);
        color: #0f172a;
      }

      .rainbow-mode .panel::after {
        animation: rainbowShift 10s linear infinite;
      }

      .leaf-mode .btn,
      .leaf-mode .btn-equals {
        position: relative;
        overflow: hidden;
        border-radius: 28px 28px 28px 12px;
        background:
          linear-gradient(140deg, rgba(119, 182, 134, 0.65), rgba(78, 143, 100, 0.2)),
          radial-gradient(120px 60px at 25% 20%, rgba(255, 255, 255, 0.35), transparent 70%);
        box-shadow: inset 0 0 0 1px rgba(78, 143, 100, 0.25), 0 10px 18px rgba(78, 143, 100, 0.2);
      }

      .leaf-mode .btn::after,
      .leaf-mode .btn-equals::after {
        content: "";
        position: absolute;
        inset: 6px;
        border-radius: inherit;
        background: linear-gradient(120deg, transparent 46%, rgba(255, 255, 255, 0.35) 50%, transparent 54%);
        opacity: 0.45;
        pointer-events: none;
      }

      .neon-mode .panel {
        box-shadow:
          0 0 0 1px rgba(74, 222, 128, 0.35),
          0 20px 50px rgba(5, 10, 18, 0.45),
          0 0 30px rgba(74, 222, 128, 0.4);
      }

      .cyber-mode .panel::after {
        background:
          linear-gradient(90deg, rgba(34, 211, 238, 0.9) 0 2px, transparent 2px) left top / 26px 26px no-repeat,
          linear-gradient(0deg, rgba(34, 211, 238, 0.9) 0 2px, transparent 2px) left top / 26px 26px no-repeat,
          linear-gradient(180deg, rgba(34, 211, 238, 0.9) 0 2px, transparent 2px) right top / 26px 26px no-repeat,
          linear-gradient(90deg, rgba(34, 211, 238, 0.9) 0 2px, transparent 2px) right top / 26px 26px no-repeat,
          linear-gradient(90deg, rgba(34, 211, 238, 0.9) 0 2px, transparent 2px) left bottom / 26px 26px no-repeat,
          linear-gradient(0deg, rgba(34, 211, 238, 0.9) 0 2px, transparent 2px) left bottom / 26px 26px no-repeat,
          linear-gradient(180deg, rgba(34, 211, 238, 0.9) 0 2px, transparent 2px) right bottom / 26px 26px no-repeat,
          linear-gradient(90deg, rgba(34, 211, 238, 0.9) 0 2px, transparent 2px) right bottom / 26px 26px no-repeat,
          var(--theme-overlay);
      }

      .cyber-mode .display-screen {
        box-shadow: 0 0 26px rgba(34, 211, 238, 0.3), inset 0 0 0 1px rgba(34, 211, 238, 0.2);
      }

      @keyframes rainbowShift {
        0% {
          filter: hue-rotate(0deg);
        }
        100% {
          filter: hue-rotate(360deg);
        }
      }

      @keyframes prismSheen {
        0% {
          background-position: 0% 50%;
        }
        100% {
          background-position: 200% 50%;
        }
      }

      @keyframes noirFlicker {
        0%,
        100% {
          opacity: 0.9;
        }
        50% {
          opacity: 1;
        }
      }

      @keyframes zenPulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.4;
        }
        50% {
          transform: scale(1.03);
          opacity: 0.7;
        }
      }

      @keyframes magmaGlow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(255, 107, 53, 0.35);
        }
        50% {
          box-shadow: 0 0 30px rgba(255, 107, 53, 0.6);
        }
      }

      @keyframes circuitScan {
        0% {
          background-position: 0% 0%;
        }
        100% {
          background-position: 120% 0%;
        }
      }

      @keyframes paperFloat {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-2px);
        }
      }

      .dynamic-mode .btn {
        transition: transform 120ms ease, background 200ms ease, box-shadow 200ms ease, filter 200ms ease;
      }

      .dynamic-mode .btn:hover {
        filter: brightness(1.1) saturate(1.2);
      }

      .flash-glow {
        animation: flashGlow 0.6s ease;
        box-shadow: 0 0 18px var(--flash-color), 0 0 38px var(--flash-color);
      }

      .flash-gradient.flash-glow {
        background: var(--flash-gradient);
        color: #0b0f14;
        box-shadow: 0 0 18px rgba(255, 255, 255, 0.6), 0 0 38px rgba(255, 255, 255, 0.45);
      }

      .background-number {
        position: absolute;
        font-size: clamp(1.2rem, 4vw, 3rem);
        color: rgba(255, 255, 255, 0.12);
        pointer-events: none;
        animation: throwNumber 1.2s ease forwards;
        text-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
      }

      .background-number.fade-out {
        animation: fadeOut 0.5s ease forwards;
      }

      @keyframes fadeOut {
        0% {
          opacity: 0.6;
        }
        100% {
          opacity: 0;
          transform: scale(1.1);
        }
      }

      @keyframes throwNumber {
        0% {
          transform: translate(0, 0) scale(0.8);
          opacity: 0.6;
        }
        100% {
          transform: translate(var(--throw-x), var(--throw-y)) scale(1.4);
          opacity: 0;
        }
      }

      @keyframes flashGlow {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        60% {
          transform: scale(1.02);
          opacity: 0.9;
        }
        100% {
          transform: scale(1);
          opacity: 0.6;
        }
      }

      @media (max-width: 980px) {
        .layout {
          padding-right: 0;
          grid-template-columns: 1fr;
        }

        .settings-shell {
          position: static;
          width: 100%;
          order: -1;
        }

        .settings-card {
          min-height: auto;
        }

        .settings-face {
          position: static;
          backface-visibility: visible;
          transform: none;
        }

        .settings-shell.is-open .settings-card {
          transform: none;
        }

        .settings-front {
          display: none;
        }

        .scientific {
          grid-template-columns: repeat(4, minmax(0, 1fr));
        }
      }

      @media (max-width: 600px) {
        .keypad,
        .scientific {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .btn-equals {
          grid-column: span 3;
        }
      }
    </style>
  </head>
  <body data-app-id="calculator">
    <div id="number-field" aria-hidden="true"></div>
    <div class="shell">
      <header>
        <div class="title-block">
          <div class="eyebrow">Ultra Scientific</div>
          <h1>Quantum Ledger Calculator</h1>
          <p class="subtitle">
            Precision meets flair. Configure the vibe, tap into advanced functions,
            and let the interface react to your flow.
          </p>
        </div>
        <div class="mode-strip">
          <div class="mode-pill" id="mode-label">Satisfying</div>
          <div class="mode-pill" id="dynamic-label">Dynamic: Off</div>
        </div>
        <button class="settings-toggle" id="settings-toggle" type="button">
          Settings
        </button>
      </header>

      <section class="layout">
        <aside class="panel memory-panel">
          <div class="memory-header">
            <h2>Memory</h2>
            <span class="memory-count" id="memory-count">0 entries</span>
          </div>
          <div class="memory-list" id="memory-list">
            <div class="memory-empty">No stored values yet.</div>
          </div>
        </aside>
        <div class="panel calculator-panel">
          <div class="display">
            <div class="display-screen" id="display">
              <div class="expression" id="expression">0</div>
              <div class="result" id="result">0</div>
            </div>
            <div class="keypad">
              <button class="btn btn-clear" data-action="clear">AC</button>
              <button class="btn btn-clear" data-action="clear-entry">C</button>
              <button class="btn" data-action="backspace">⌫</button>
              <button class="btn btn-operator" data-value="/">÷</button>

              <button class="btn" data-value="7">7</button>
              <button class="btn" data-value="8">8</button>
              <button class="btn" data-value="9">9</button>
              <button class="btn btn-operator" data-value="*">×</button>

              <button class="btn" data-value="4">4</button>
              <button class="btn" data-value="5">5</button>
              <button class="btn" data-value="6">6</button>
              <button class="btn btn-operator" data-value="-">−</button>

              <button class="btn" data-value="1">1</button>
              <button class="btn" data-value="2">2</button>
              <button class="btn" data-value="3">3</button>
              <button class="btn btn-operator" data-value="+">+</button>

              <button class="btn btn-wide" data-value="0">0</button>
              <button class="btn" data-value=".">.</button>
              <button class="btn btn-equals" data-action="equals">=</button>
            </div>

            <div class="memory-keys" aria-label="Memory controls">
              <button class="btn" data-action="mc">mc</button>
              <button class="btn" data-action="mplus">m+</button>
              <button class="btn" data-action="mminus">m-</button>
              <button class="btn" data-action="mr">mr</button>
              <button class="btn" data-action="rcl">rcl</button>
            </div>

            <div class="scientific">
              <button class="btn" data-action="second" id="second-toggle">2nd</button>
              <button class="btn" data-value="(">(</button>
              <button class="btn" data-value=")">)</button>
              <button class="btn" data-fn="inv">1/x</button>
              <button class="btn" data-fn="square">x²</button>
              <button class="btn" data-fn="cube">x³</button>

              <button class="btn" data-fn="sqrt">√x</button>
              <button class="btn" data-fn="cbrt">∛x</button>
              <button class="btn" data-fn="yroot">y√x</button>
              <button class="btn" data-fn="expn">a^b</button>
              <button class="btn" data-fn="ee">EE</button>

              <button class="btn trig-btn" data-fn="sin" data-alt-fn="sinh">sin</button>
              <button class="btn trig-btn" data-fn="cos" data-alt-fn="cosh">cos</button>
              <button class="btn trig-btn" data-fn="tan" data-alt-fn="tanh">tan</button>
              <button class="btn" data-fn="ln">ln</button>
              <button class="btn" data-fn="log">log₁₀</button>

              <button class="btn" data-fn="exp">eˣ</button>
              <button class="btn" data-fn="tenpow">10ˣ</button>
              <button class="btn" data-fn="pi">π</button>
              <button class="btn" data-fn="e">e</button>
              <button class="btn" data-fn="rand">Rand</button>

              <button class="btn" data-fn="deg">deg</button>
              <button class="btn" data-fn="i">i</button>
              <button class="btn" data-fn="tetration">a^^b</button>
              <button class="btn" data-fn="pentation">a^^^b</button>
              <button class="btn" data-fn="hexation">a^^^^b</button>

              <button class="btn btn-operator" data-value="%">%</button>
            </div>
          </div>
        </div>

        <aside class="settings-shell" id="settings-shell">
          <div class="settings-card" id="settings-card">
            <div class="settings-face settings-front panel">
              <div class="settings-icon">⚙</div>
              <h2>Settings</h2>
              <p class="legend">Tap to reveal themes and flair controls.</p>
              <button class="settings-toggle" id="settings-open" type="button">
                Open
              </button>
            </div>
            <div class="settings-face settings-back panel settings">
              <h2>Settings</h2>
              <div class="setting-group">
                <label for="theme-select">Theme</label>
                <select id="theme-select">
                  <option value="satisfying">Satisfying</option>
                  <option value="ultra-unsatisfying">Ultra Unsatisfying</option>
                  <option value="ultra-satisfying">Ultra Satisfying</option>
                  <option value="leaf">Leaf Theme</option>
                  <option value="rainbow">Rainbow Theme</option>
                  <option value="aurora">Aurora</option>
                  <option value="midnight">Midnight</option>
                  <option value="solar">Solar</option>
                  <option value="graphite">Graphite</option>
                  <option value="candy">Candy</option>
                  <option value="glacier">Glacier</option>
                  <option value="ember">Ember</option>
                  <option value="neon">Neon</option>
                  <option value="lavender">Lavender</option>
                  <option value="sand">Sand</option>
                  <option value="ocean">Ocean</option>
                  <option value="citrus">Citrus</option>
                  <option value="mono">Mono</option>
                  <option value="rose">Rose</option>
                  <option value="brass">Brass</option>
                  <option value="cyber">Cyber</option>
                  <option value="prism">Prism Glass</option>
                  <option value="noir">Noir Film</option>
                  <option value="zen">Zen Ink</option>
                  <option value="magma">Magma Rift</option>
                  <option value="circuit">Circuit Forge</option>
                  <option value="paper">Paper Lab</option>
                </select>
              </div>
              <div class="setting-group toggle">
                <input type="checkbox" id="dynamic-toggle" />
                <label for="dynamic-toggle">Dynamic Mode</label>
              </div>
              <p class="legend">
                Dynamic mode amplifies hover effects and adds reactive ripples on
                touch.
              </p>
              <div class="setting-group toggle">
                <input type="checkbox" id="flash-toggle" />
                <label for="flash-toggle">Flash Flair</label>
              </div>
              <div class="setting-group">
                <label for="flash-frequency">Flash Frequency</label>
                <input
                  type="range"
                  id="flash-frequency"
                  min="0.0002778"
                  max="10"
                  step="0.0001"
                  value="0.2"
                />
                <div class="legend" id="flash-frequency-label">
                  0.2 flashes/sec
                </div>
              </div>
              <div class="setting-group toggle">
                <input type="checkbox" id="flash-rainbow" />
                <label for="flash-rainbow">Rainbow Flash</label>
              </div>
              <div class="setting-group">
                <label>Precision</label>
                <div class="legend">Arbitrary (no rounding applied).</div>
              </div>
              <button class="settings-toggle" id="settings-close" type="button">
                Close
              </button>
            </div>
          </div>
        </aside>
      </section>
    </div>

    <div class="tutorial-overlay" id="tutorial-overlay">
      <div class="tutorial-card">
        <strong id="tutorial-title">Memory Tutorial</strong>
        <div id="tutorial-body">Use the memory keys to store and recall values.</div>
        <div class="tutorial-actions">
          <button class="btn" id="tutorial-next">Next</button>
          <button class="btn btn-clear" id="tutorial-close">Close</button>
        </div>
      </div>
    </div>

    <script>
      const expressionEl = document.getElementById("expression");
      const resultEl = document.getElementById("result");
      const displayEl = document.getElementById("display");
      const numberField = document.getElementById("number-field");
      const memoryList = document.getElementById("memory-list");
      const memoryCount = document.getElementById("memory-count");
      const themeSelect = document.getElementById("theme-select");
      const settingsShell = document.getElementById("settings-shell");
      const settingsToggle = document.getElementById("settings-toggle");
      const settingsOpen = document.getElementById("settings-open");
      const settingsClose = document.getElementById("settings-close");
      const secondToggle = document.getElementById("second-toggle");
      const modeLabel = document.getElementById("mode-label");
      const dynamicLabel = document.getElementById("dynamic-label");
      const dynamicToggle = document.getElementById("dynamic-toggle");
      const flashToggle = document.getElementById("flash-toggle");
      const flashFrequency = document.getElementById("flash-frequency");
      const flashFrequencyLabel = document.getElementById("flash-frequency-label");
      const flashRainbow = document.getElementById("flash-rainbow");
      const tutorialOverlay = document.getElementById("tutorial-overlay");
      const tutorialTitle = document.getElementById("tutorial-title");
      const tutorialBody = document.getElementById("tutorial-body");
      const tutorialNext = document.getElementById("tutorial-next");
      const tutorialClose = document.getElementById("tutorial-close");

      let expression = "";
      let lastResult = 0;
      let awaitingPow = false;
      let pendingHyper = null;
      let pendingBase = null;
      let pendingExponent = "";
      let pendingRoot = false;
      let pendingRootBase = null;
      let pendingRootExponent = "";
      let useDegrees = true;
      let secondMode = false;
      const memoryEntries = [];
      let flashTimer = null;
      let flashRate = 0.2;
      let flashEnabled = false;
      let flashUseRainbow = false;

      const updateDisplay = () => {
        expressionEl.textContent = expression || "0";
        resultEl.textContent = formatResult(lastResult);
      };

      const formatResult = (value) => {
        if (typeof value === "string") return value;
        if (value && typeof value === "object" && "re" in value) {
          return complexToString(value);
        }
        if (!isFinite(value)) return "Error";
        if (Math.abs(value) < 1e-12) return "0";
        return Number(value).toString();
      };

      const complexToString = (c) => {
        const re = Math.abs(c.re) < 1e-10 ? 0 : c.re;
        const im = Math.abs(c.im) < 1e-10 ? 0 : c.im;
        if (im === 0) return re.toString();
        if (re === 0) return `${im}i`;
        const sign = im > 0 ? "+" : "-";
        return `${re}${sign}${Math.abs(im)}i`;
      };

      const evalExpression = (expr) => {
        if (!expr) return 0;
        try {
          if (expr.includes("i")) {
            return evalComplex(expr);
          }
          return evalReal(expr);
        } catch (err) {
          return lastResult || 0;
        }
      };

      const evalReal = (expr) => {
        const sanitized = expr.replace(/[^0-9+\-*/().%eE]/g, "");
        if (!sanitized) return 0;
        return Function(`"use strict"; return (${sanitized})`)();
      };

      const evalComplex = (expr) => {
        const tokens = tokenize(expr);
        const rpn = toRpn(tokens);
        return evalRpn(rpn);
      };

      const applyTheme = (theme) => {
        document.body.classList.remove(
          "satisfying-mode",
          "ultra-unsatisfying",
          "ultra-satisfying",
          "leaf-mode",
          "rainbow-mode",
          "aurora-mode",
          "midnight-mode",
          "solar-mode",
          "graphite-mode",
          "candy-mode",
          "glacier-mode",
          "ember-mode",
          "neon-mode",
          "lavender-mode",
          "sand-mode",
          "ocean-mode",
          "citrus-mode",
          "mono-mode",
          "rose-mode",
          "brass-mode",
          "cyber-mode",
          "prism-mode",
          "noir-mode",
          "zen-mode",
          "magma-mode",
          "circuit-mode",
          "paper-mode"
        );
        if (theme === "satisfying") document.body.classList.add("satisfying-mode");
        if (theme === "ultra-unsatisfying") document.body.classList.add("ultra-unsatisfying");
        if (theme === "ultra-satisfying") document.body.classList.add("ultra-satisfying");
        if (theme === "leaf") document.body.classList.add("leaf-mode");
        if (theme === "rainbow") document.body.classList.add("rainbow-mode");
        if (theme === "aurora") document.body.classList.add("aurora-mode");
        if (theme === "midnight") document.body.classList.add("midnight-mode");
        if (theme === "solar") document.body.classList.add("solar-mode");
        if (theme === "graphite") document.body.classList.add("graphite-mode");
        if (theme === "candy") document.body.classList.add("candy-mode");
        if (theme === "glacier") document.body.classList.add("glacier-mode");
        if (theme === "ember") document.body.classList.add("ember-mode");
        if (theme === "neon") document.body.classList.add("neon-mode");
        if (theme === "lavender") document.body.classList.add("lavender-mode");
        if (theme === "sand") document.body.classList.add("sand-mode");
        if (theme === "ocean") document.body.classList.add("ocean-mode");
        if (theme === "citrus") document.body.classList.add("citrus-mode");
        if (theme === "mono") document.body.classList.add("mono-mode");
        if (theme === "rose") document.body.classList.add("rose-mode");
        if (theme === "brass") document.body.classList.add("brass-mode");
        if (theme === "cyber") document.body.classList.add("cyber-mode");
        if (theme === "prism") document.body.classList.add("prism-mode");
        if (theme === "noir") document.body.classList.add("noir-mode");
        if (theme === "zen") document.body.classList.add("zen-mode");
        if (theme === "magma") document.body.classList.add("magma-mode");
        if (theme === "circuit") document.body.classList.add("circuit-mode");
        if (theme === "paper") document.body.classList.add("paper-mode");
        modeLabel.textContent = theme.replace(/-/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
      };

      const setDynamic = (enabled) => {
        document.body.classList.toggle("dynamic-mode", enabled);
        dynamicLabel.textContent = enabled ? "Dynamic: On" : "Dynamic: Off";
      };

      const throwNumber = (val) => {
        if (!dynamicToggle.checked) return;
        if (!val || !/[0-9.]/.test(val)) return;
        const node = document.createElement("div");
        node.className = "background-number";
        node.textContent = val;
        const rect = numberField.getBoundingClientRect();
        const startX = rect.width * 0.4 + Math.random() * rect.width * 0.2;
        const startY = rect.height * 0.35 + Math.random() * rect.height * 0.2;
        const endX = (Math.random() - 0.5) * rect.width * 0.8;
        const endY = (Math.random() - 0.5) * rect.height * 0.6;
        node.style.left = `${startX}px`;
        node.style.top = `${startY}px`;
        node.style.setProperty("--throw-x", `${endX}px`);
        node.style.setProperty("--throw-y", `${endY}px`);
        numberField.appendChild(node);
        setTimeout(() => node.remove(), 1200);
      };

      const setSettingsOpen = (open) => {
        settingsShell.classList.toggle("is-open", open);
      };

      const updateFlashLabel = () => {
        const perSecond = flashRate;
        if (perSecond < 1 / 60) {
          const hours = 1 / perSecond / 3600;
          flashFrequencyLabel.textContent = `${hours.toFixed(1)} per hour`;
        } else if (perSecond < 1) {
          const minutes = 1 / perSecond / 60;
          flashFrequencyLabel.textContent = `${minutes.toFixed(1)} per minute`;
        } else {
          flashFrequencyLabel.textContent = `${perSecond.toFixed(2)} flashes/sec`;
        }
      };

      const triggerFlash = () => {
        const buttons = document.querySelectorAll(".btn");
        if (!buttons.length) return;
        const target = buttons[Math.floor(Math.random() * buttons.length)];
        const hue = Math.floor(Math.random() * 360);
        const brightPalette = ["#ff7a59", "#ffd166", "#06d6a0", "#4cc9f0", "#b5179e"];
        if (flashUseRainbow) {
          const c1 = `hsla(${hue}, 90%, 70%, 0.9)`;
          const c2 = `hsla(${(hue + 80) % 360}, 90%, 70%, 0.9)`;
          const c3 = `hsla(${(hue + 160) % 360}, 90%, 70%, 0.9)`;
          target.style.setProperty("--flash-gradient", `linear-gradient(120deg, ${c1}, ${c2}, ${c3})`);
          target.classList.add("flash-gradient");
        } else {
          const color = brightPalette[Math.floor(Math.random() * brightPalette.length)];
          target.style.setProperty("--flash-color", color);
          target.classList.remove("flash-gradient");
        }
        target.classList.remove("flash-glow");
        void target.offsetWidth;
        target.classList.add("flash-glow");
        setTimeout(() => target.classList.remove("flash-glow"), 600);
      };

      const scheduleFlash = () => {
        if (flashTimer) clearTimeout(flashTimer);
        if (!flashEnabled) return;
        const interval = Math.max(50, 1000 / flashRate);
        flashTimer = setTimeout(() => {
          triggerFlash();
          scheduleFlash();
        }, interval);
      };

      const renderMemory = () => {
        memoryList.innerHTML = "";
        memoryCount.textContent = `${memoryEntries.length} entries`;
        if (!memoryEntries.length) {
          const empty = document.createElement("div");
          empty.className = "memory-empty";
          empty.textContent = "No stored values yet.";
          memoryList.appendChild(empty);
          return;
        }
        const start = Math.max(0, memoryEntries.length - 200);
        for (let i = memoryEntries.length - 1; i >= start; i -= 1) {
          const entry = memoryEntries[i];
          const item = document.createElement("button");
          item.type = "button";
          item.className = "memory-item";
          const label = document.createElement("span");
          label.textContent = entry;
          const del = document.createElement("button");
          del.type = "button";
          del.className = "memory-delete";
          del.textContent = "×";
          del.addEventListener("click", (event) => {
            event.stopPropagation();
            memoryEntries.splice(i, 1);
            saveMemory();
            renderMemory();
          });
          item.appendChild(label);
          item.appendChild(del);
          item.addEventListener("click", () => {
            expression = entry.toString();
            lastResult = evalExpression(expression);
            updateDisplay();
          });
          memoryList.appendChild(item);
        }
      };

      const saveMemory = () => {
        localStorage.setItem("calculator-memory", JSON.stringify(memoryEntries));
      };

      const loadMemory = () => {
        const raw = localStorage.getItem("calculator-memory");
        if (!raw) return;
        try {
          const values = JSON.parse(raw);
          if (Array.isArray(values)) {
            memoryEntries.splice(0, memoryEntries.length, ...values);
          }
        } catch (err) {
          memoryEntries.length = 0;
        }
      };

      const addMemory = (value) => {
        if (value && typeof value === "object" && "re" in value) {
          value = complexToString(value);
        }
        if (typeof value === "string" && !value.length) return;
        memoryEntries.push(value);
        saveMemory();
        renderMemory();
      };

      const recallMemory = () => {
        if (!memoryEntries.length) return;
        const value = memoryEntries[memoryEntries.length - 1];
        pendingHyper = null;
        pendingBase = null;
        pendingExponent = "";
        pendingRoot = false;
        pendingRootBase = null;
        pendingRootExponent = "";
        expression = value.toString();
        lastResult = evalExpression(expression);
        updateDisplay();
      };

      const tutorialSteps = [
        { title: "Memory Basics", body: "Tap m+ to store the current value, or m- to store a negative value." },
        { title: "Recall", body: "Tap mr or rcl to bring back the most recent stored value." },
        { title: "Clear & Delete", body: "Tap mc to clear all memory. Use the × button next to a value to delete a single entry." },
      ];
      let tutorialIndex = 0;

      const showTutorial = (index = 0) => {
        tutorialIndex = index;
        const step = tutorialSteps[tutorialIndex];
        tutorialTitle.textContent = step.title;
        tutorialBody.textContent = step.body;
        tutorialOverlay.style.display = "flex";
      };

      tutorialNext.addEventListener("click", () => {
        tutorialIndex = (tutorialIndex + 1) % tutorialSteps.length;
        const step = tutorialSteps[tutorialIndex];
        tutorialTitle.textContent = step.title;
        tutorialBody.textContent = step.body;
      });

      tutorialClose.addEventListener("click", () => {
        tutorialOverlay.style.display = "none";
        localStorage.setItem("calculator-tutorial", "seen");
      });

      const toggleSecond = () => {
        secondMode = !secondMode;
        document.querySelectorAll(".trig-btn").forEach((btn) => {
          const baseFn = btn.getAttribute("data-base-fn") || btn.getAttribute("data-fn");
          const altFn = btn.getAttribute("data-alt-fn");
          const baseLabel = btn.getAttribute("data-label") || btn.textContent;
          if (!btn.getAttribute("data-label")) btn.setAttribute("data-label", baseLabel);
          btn.setAttribute("data-base-fn", baseFn);
          if (secondMode) {
            btn.textContent = altFn;
            btn.setAttribute("data-fn", altFn);
          } else {
            btn.textContent = btn.getAttribute("data-label");
            btn.setAttribute("data-fn", baseFn);
          }
        });
      };

      const insertValue = (val) => {
        if (pendingHyper) {
          pendingExponent += val;
          expression = `${pendingBase} ${pendingHyper.symbol} ${pendingExponent}`;
          updateDisplay();
          throwNumber(val);
          return;
        }
        if (pendingRoot) {
          pendingRootExponent += val;
          expression = `${pendingRootBase} y√ ${pendingRootExponent}`;
          updateDisplay();
          throwNumber(val);
          return;
        }
        if (val === "i") {
          if (expression && /[0-9)i]$/.test(expression)) {
            expression += "*i";
          } else {
            expression += "i";
          }
          lastResult = evalExpression(expression);
          updateDisplay();
          throwNumber(val);
          return;
        }
        expression += val;
        lastResult = evalExpression(expression);
        updateDisplay();
        throwNumber(val);
      };

      const insertExponent = () => {
        if (!expression || !/[0-9)]$/.test(expression)) {
          expression += "1e";
        } else {
          expression += "e";
        }
        updateDisplay();
      };

      const hyperOp = (a, b, level) => {
        if (!Number.isFinite(a) || !Number.isFinite(b)) return NaN;
        const n = Math.max(0, Math.floor(b));
        if (level === 3) return Math.pow(a, n);
        if (n === 0) return level === 4 ? 1 : level === 5 ? a : a;
        let result = a;
        for (let i = 1; i < n; i += 1) {
          if (level === 4) result = Math.pow(a, result);
          if (level === 5) result = hyperOp(a, result, 4);
          if (level === 6) result = hyperOp(a, result, 5);
          if (!isFinite(result)) return Infinity;
          if (result > 1e6) return Infinity;
        }
        return result;
      };

      const tokenize = (expr) => {
        const tokens = [];
        const re = /\s*([0-9]+(?:\.[0-9]+)?(?:[eE][+-]?[0-9]+)?|[()+\-*/^%]|i)\s*/g;
        let match;
        while ((match = re.exec(expr))) {
          tokens.push(match[1]);
        }
        return tokens;
      };

      const toRpn = (tokens) => {
        const output = [];
        const ops = [];
        const prec = { "^": 4, "*": 3, "/": 3, "%": 3, "+": 2, "-": 2 };
        const rightAssoc = { "^": true };
        let prev = null;
        tokens.forEach((token) => {
          if (/^[0-9]/.test(token) || token === "i") {
            output.push(token);
          } else if (token === "(") {
            ops.push(token);
          } else if (token === ")") {
            while (ops.length && ops[ops.length - 1] !== "(") {
              output.push(ops.pop());
            }
            ops.pop();
          } else {
            if (token === "-" && (prev === null || ["(", "+", "-", "*", "/", "^", "%"].includes(prev))) {
              output.push("0");
            }
            while (
              ops.length &&
              ops[ops.length - 1] !== "(" &&
              (prec[ops[ops.length - 1]] > prec[token] ||
                (prec[ops[ops.length - 1]] === prec[token] && !rightAssoc[token]))
            ) {
              output.push(ops.pop());
            }
            ops.push(token);
          }
          prev = token;
        });
        while (ops.length) output.push(ops.pop());
        return output;
      };

      const toComplex = (value) => {
        if (typeof value === "object") return value;
        if (value === "i") return { re: 0, im: 1 };
        return { re: parseFloat(value), im: 0 };
      };

      const complexAdd = (a, b) => ({ re: a.re + b.re, im: a.im + b.im });
      const complexSub = (a, b) => ({ re: a.re - b.re, im: a.im - b.im });
      const complexMul = (a, b) => ({
        re: a.re * b.re - a.im * b.im,
        im: a.re * b.im + a.im * b.re,
      });
      const complexDiv = (a, b) => {
        const denom = b.re * b.re + b.im * b.im;
        return {
          re: (a.re * b.re + a.im * b.im) / denom,
          im: (a.im * b.re - a.re * b.im) / denom,
        };
      };
      const complexPow = (a, b) => {
        if (Math.abs(b.im) > 1e-10) return { re: NaN, im: NaN };
        const exp = b.re;
        if (a.im === 0) return { re: Math.pow(a.re, exp), im: 0 };
        const r = Math.hypot(a.re, a.im);
        const theta = Math.atan2(a.im, a.re);
        const rn = Math.pow(r, exp);
        return { re: rn * Math.cos(theta * exp), im: rn * Math.sin(theta * exp) };
      };

      const evalRpn = (rpn) => {
        const stack = [];
        rpn.forEach((token) => {
          if (/^[0-9]/.test(token) || token === "i") {
            stack.push(toComplex(token));
          } else {
            const b = stack.pop();
            const a = stack.pop();
            if (!a || !b) return;
            let result;
            switch (token) {
              case "+":
                result = complexAdd(a, b);
                break;
              case "-":
                result = complexSub(a, b);
                break;
              case "*":
                result = complexMul(a, b);
                break;
              case "/":
                result = complexDiv(a, b);
                break;
              case "%":
                result = { re: a.re % b.re, im: 0 };
                break;
              case "^":
                result = complexPow(a, b);
                break;
              default:
                result = { re: NaN, im: NaN };
            }
            stack.push(result);
          }
        });
        return stack.pop() || { re: 0, im: 0 };
      };

      const handleScientific = (fn) => {
        if (fn === "deg") {
          useDegrees = !useDegrees;
          showPulse();
          return;
        }
        if (fn === "i") {
          insertValue("i");
          return;
        }
        if (fn === "ee") {
          insertExponent();
          return;
        }

        let value = expression ? evalExpression(expression) : lastResult;
        if (value && typeof value === "object" && "re" in value) {
          if (Math.abs(value.im) > 1e-10) {
            lastResult = "Complex op not supported";
            updateDisplay();
            return;
          }
          value = value.re;
        }
        const angle = useDegrees ? (value * Math.PI) / 180 : value;
        let result = value;

        switch (fn) {
          case "sin":
            result = Math.sin(angle);
            break;
          case "cos":
            result = Math.cos(angle);
            break;
          case "tan":
            result = Math.tan(angle);
            break;
          case "sinh":
            result = Math.sinh(value);
            break;
          case "cosh":
            result = Math.cosh(value);
            break;
          case "tanh":
            result = Math.tanh(value);
            break;
          case "log":
            result = Math.log10(value);
            break;
          case "ln":
            result = Math.log(value);
            break;
          case "sqrt":
            result = Math.sqrt(value);
            break;
          case "cbrt":
            result = Math.cbrt(value);
            break;
          case "inv":
            result = 1 / value;
            break;
          case "square":
            result = Math.pow(value, 2);
            break;
          case "cube":
            result = Math.pow(value, 3);
            break;
          case "yroot":
            pendingRoot = true;
            pendingRootBase = value;
            pendingRootExponent = "";
            expression = `${pendingRootBase} y√`;
            updateDisplay();
            return;
          case "expn":
            pendingHyper = { level: 3, symbol: "^" };
            pendingBase = value;
            pendingExponent = "";
            expression = `${pendingBase} ^`;
            updateDisplay();
            return;
          case "pi":
            result = Math.PI;
            break;
          case "e":
            result = Math.E;
            break;
          case "exp":
            result = Math.exp(value);
            break;
          case "tenpow":
            result = Math.pow(10, value);
            break;
          case "rand":
            result = Math.random();
            break;
          case "abs":
            result = Math.abs(value);
            break;
          case "factorial":
            result = factorial(value);
            break;
          case "tetration":
            pendingHyper = { level: 4, symbol: "^^" };
            pendingBase = value;
            pendingExponent = "";
            expression = `${pendingBase} ^^`;
            updateDisplay();
            return;
          case "pentation":
            pendingHyper = { level: 5, symbol: "^^^" };
            pendingBase = value;
            pendingExponent = "";
            expression = `${pendingBase} ^^^`;
            updateDisplay();
            return;
          case "hexation":
            pendingHyper = { level: 6, symbol: "^^^^" };
            pendingBase = value;
            pendingExponent = "";
            expression = `${pendingBase} ^^^^`;
            updateDisplay();
            return;
          default:
            break;
        }

        expression = result.toString();
        lastResult = result;
        updateDisplay();
        showPulse();
      };

      const factorial = (value) => {
        const n = Math.floor(Math.abs(value));
        if (n > 170) return Infinity;
        let total = 1;
        for (let i = 2; i <= n; i += 1) total *= i;
        return total;
      };

      const showPulse = () => {
        displayEl.classList.remove("pulse");
        void displayEl.offsetWidth;
        displayEl.classList.add("pulse");
      };

      const createSplash = (event) => {
        if (!dynamicToggle.checked) return;
        const splash = document.createElement("div");
        splash.className = "dynamic-splash";
        const rect = document.body.getBoundingClientRect();
        const x = (event.clientX || rect.width / 2) - 70;
        const y = (event.clientY || rect.height / 2) - 70;
        const hue = Math.floor(Math.random() * 360);
        splash.style.left = `${x}px`;
        splash.style.top = `${y}px`;
        splash.style.background = `radial-gradient(circle, hsla(${hue}, 90%, 70%, 0.9), transparent 70%)`;
        document.body.appendChild(splash);
        setTimeout(() => splash.remove(), 700);
      };

      const handleClick = (event) => {
        const button = event.target.closest("button");
        if (!button) return;

        createSplash(event);

        const value = button.dataset.value;
        const action = button.dataset.action;
        const fn = button.dataset.fn;

        if (value) {
          insertValue(value);
          return;
        }

        if (fn) {
          handleScientific(fn);
          return;
        }

        if (action === "clear") {
          expression = "";
          lastResult = 0;
          awaitingPow = false;
          pendingHyper = null;
          pendingBase = null;
          pendingExponent = "";
          pendingRoot = false;
          pendingRootBase = null;
          pendingRootExponent = "";
          updateDisplay();
          showPulse();
          numberField.querySelectorAll(".background-number").forEach((node) => {
            node.classList.add("fade-out");
            setTimeout(() => node.remove(), 500);
          });
        }

        if (action === "clear-entry") {
          expression = "";
          updateDisplay();
          showPulse();
        }

        if (action === "second") {
          toggleSecond();
          showPulse();
        }

        if (action === "mc") {
          memoryEntries.length = 0;
          saveMemory();
          renderMemory();
        }

        if (action === "mr") {
          recallMemory();
        }

        if (action === "rcl") {
          recallMemory();
        }

        if (action === "mplus") {
          addMemory(lastResult);
        }

        if (action === "mminus") {
          const val = lastResult && typeof lastResult === "object" && "re" in lastResult
            ? { re: -lastResult.re, im: -lastResult.im }
            : -Number(lastResult);
          addMemory(val);
        }

        if (action === "backspace") {
          if (pendingHyper && pendingExponent.length > 0) {
            pendingExponent = pendingExponent.slice(0, -1);
            expression = `${pendingBase} ${pendingHyper.symbol} ${pendingExponent}`;
            updateDisplay();
            return;
          }
          if (pendingRoot && pendingRootExponent.length > 0) {
            pendingRootExponent = pendingRootExponent.slice(0, -1);
            expression = `${pendingRootBase} y√ ${pendingRootExponent}`;
            updateDisplay();
            return;
          }
          expression = expression.slice(0, -1);
          lastResult = expression ? evalExpression(expression) : 0;
          updateDisplay();
        }

        if (action === "equals") {
          if (pendingHyper) {
            const expValue = Number(pendingExponent || 0);
            const result = hyperOp(pendingBase, expValue, pendingHyper.level);
            expression = result.toString();
            lastResult = result;
            pendingHyper = null;
            pendingBase = null;
            pendingExponent = "";
          } else if (pendingRoot) {
            const expValue = Number(pendingRootExponent || 0);
            const result = expValue === 0 ? NaN : Math.pow(pendingRootBase, 1 / expValue);
            expression = result.toString();
            lastResult = result;
            pendingRoot = false;
            pendingRootBase = null;
            pendingRootExponent = "";
          } else {
            lastResult = evalExpression(expression);
            expression =
              lastResult && typeof lastResult === "object" && "re" in lastResult
                ? complexToString(lastResult)
                : lastResult.toString();
          }
          updateDisplay();
          showPulse();
        }
      };

      document.querySelectorAll(".btn").forEach((button) => {
        button.addEventListener("click", handleClick);
      });

      themeSelect.addEventListener("change", (event) => {
        applyTheme(event.target.value);
      });

      settingsToggle.addEventListener("click", () => {
        setSettingsOpen(!settingsShell.classList.contains("is-open"));
      });

      settingsOpen.addEventListener("click", () => {
        setSettingsOpen(true);
      });

      settingsClose.addEventListener("click", () => {
        setSettingsOpen(false);
      });

      dynamicToggle.addEventListener("change", (event) => {
        setDynamic(event.target.checked);
      });

      flashToggle.addEventListener("change", (event) => {
        flashEnabled = event.target.checked;
        scheduleFlash();
      });

      flashFrequency.addEventListener("input", (event) => {
        flashRate = parseFloat(event.target.value);
        updateFlashLabel();
        scheduleFlash();
      });

      flashRainbow.addEventListener("change", (event) => {
        flashUseRainbow = event.target.checked;
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          handleClick({ target: document.querySelector('[data-action="equals"]'), clientX: window.innerWidth / 2, clientY: 120 });
          return;
        }
        if (event.key === "Backspace") {
          handleClick({ target: document.querySelector('[data-action="backspace"]'), clientX: window.innerWidth / 2, clientY: 120 });
          return;
        }
        if (event.key === "Escape") {
          handleClick({ target: document.querySelector('[data-action="clear"]'), clientX: window.innerWidth / 2, clientY: 120 });
          return;
        }
        if (/[0-9.+\-*/%()]/.test(event.key)) {
          insertValue(event.key === "*" ? "*" : event.key);
          createSplash({ clientX: window.innerWidth / 2, clientY: 120 });
        }
      });

      applyTheme("satisfying");
      setDynamic(false);
      updateFlashLabel();
      setSettingsOpen(false);
      loadMemory();
      renderMemory();
      updateDisplay();
      if (localStorage.getItem("calculator-tutorial") !== "seen") {
        setTimeout(() => showTutorial(0), 600);
      }
    </script>
    <script src="../js/lock.js"></script>
  </body>
</html>
