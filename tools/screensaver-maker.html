<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Screensaver Maker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #020617; color: #e2e8f0; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 999px; }
    input[type="range"] { accent-color: #3b82f6; }
  </style>
</head>
<body class="min-h-screen">
  <header class="sticky top-0 z-20 backdrop-blur border-b border-slate-800 bg-slate-950/70">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <div>
        <div class="text-lg font-bold text-white">Screensaver Maker</div>
        <div class="text-xs text-slate-500">Edits `../simulations/fractal-sim.html` screensaver config via localStorage.</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-preview" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs font-bold">Preview</button>
        <button id="btn-stop" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-200 rounded text-xs border border-slate-700">Stop</button>
        <button id="btn-reload" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-200 rounded text-xs border border-slate-700">Reload</button>
        <button id="btn-export" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-200 rounded text-xs border border-slate-700">Export JSON</button>
        <label class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-200 rounded text-xs border border-slate-700 cursor-pointer">
          Import JSON
          <input id="file-import" type="file" accept=".json,application/json" class="hidden" />
        </label>
        <a href="../simulations/fractal-sim.html" class="px-4 py-2 bg-slate-900 hover:bg-slate-800 text-slate-200 rounded text-xs border border-slate-700">Open Fractal</a>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-5 gap-4">
    <section class="lg:col-span-2 bg-slate-900/40 border border-slate-800 rounded-xl p-4 space-y-4">
      <div class="flex items-center justify-between">
        <div class="text-xs font-bold uppercase tracking-wider text-slate-400">Core</div>
        <label class="flex items-center gap-2 text-xs text-slate-400">
          <input id="cfg-enabled" type="checkbox" class="accent-blue-500" checked />
          Enabled
        </label>
      </div>

      <div class="space-y-3">
        <div>
          <div class="flex justify-between mb-1">
            <label class="text-[10px] text-slate-400 uppercase font-semibold">Time Scale</label>
            <span id="val-timescale" class="text-[10px] text-slate-500 font-mono">1.00x</span>
          </div>
          <input id="cfg-timescale" type="range" min="0.1" max="3" step="0.01" value="1" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="flex justify-between mb-1">
              <label class="text-[10px] text-slate-400 uppercase font-semibold">Pan Amp</label>
              <span id="val-panamp" class="text-[10px] text-slate-500 font-mono">2.0</span>
            </div>
            <input id="cfg-panamp" type="range" min="0" max="50" step="0.1" value="2" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
          </div>
          <div>
            <div class="flex justify-between mb-1">
              <label class="text-[10px] text-slate-400 uppercase font-semibold">Pan Speed</label>
              <span id="val-panspeed" class="text-[10px] text-slate-500 font-mono">1.00</span>
            </div>
            <input id="cfg-panspeed" type="range" min="0" max="10" step="0.01" value="1" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="flex justify-between mb-1">
              <label class="text-[10px] text-slate-400 uppercase font-semibold">Zoom Base</label>
              <span id="val-zoombase" class="text-[10px] text-slate-500 font-mono">0.150</span>
            </div>
            <input id="cfg-zoombase" type="range" min="0.01" max="1" step="0.001" value="0.15" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
          </div>
          <div>
            <div class="flex justify-between mb-1">
              <label class="text-[10px] text-slate-400 uppercase font-semibold">Zoom Amp</label>
              <span id="val-zoomamp" class="text-[10px] text-slate-500 font-mono">0.050</span>
            </div>
            <input id="cfg-zoomamp" type="range" min="0" max="0.5" step="0.001" value="0.05" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="flex justify-between mb-1">
              <label class="text-[10px] text-slate-400 uppercase font-semibold">Zoom Speed</label>
              <span id="val-zoomspeed" class="text-[10px] text-slate-500 font-mono">0.50</span>
            </div>
            <input id="cfg-zoomspeed" type="range" min="0" max="5" step="0.01" value="0.5" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
          </div>
          <div>
            <div class="flex justify-between mb-1">
              <label class="text-[10px] text-slate-400 uppercase font-semibold">Rotate °/s</label>
              <span id="val-rot" class="text-[10px] text-slate-500 font-mono">0.0</span>
            </div>
            <input id="cfg-rot" type="range" min="-120" max="120" step="0.1" value="0" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
          </div>
        </div>
      </div>

      <div class="border-t border-slate-800 pt-4 space-y-3">
        <div class="text-xs font-bold uppercase tracking-wider text-slate-400">Cycling</div>
        <div class="grid grid-cols-3 gap-2">
          <label class="flex items-center justify-between gap-2 p-2 bg-slate-950/40 border border-slate-800 rounded text-xs">
            <span class="text-slate-400">Themes</span>
            <input id="cfg-cycle-theme" type="checkbox" class="accent-blue-500" />
          </label>
          <label class="flex items-center justify-between gap-2 p-2 bg-slate-950/40 border border-slate-800 rounded text-xs">
            <span class="text-slate-400">Layouts</span>
            <input id="cfg-cycle-layout" type="checkbox" class="accent-blue-500" />
          </label>
          <label class="flex items-center justify-between gap-2 p-2 bg-slate-950/40 border border-slate-800 rounded text-xs">
            <span class="text-slate-400">Seeds</span>
            <input id="cfg-cycle-seed" type="checkbox" class="accent-blue-500" />
          </label>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="flex justify-between mb-1">
              <label class="text-[10px] text-slate-400 uppercase font-semibold">Period (s)</label>
              <span id="val-period" class="text-[10px] text-slate-500 font-mono">8</span>
            </div>
            <input id="cfg-period" type="range" min="1" max="60" step="1" value="8" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
          </div>
          <div>
            <div class="flex justify-between mb-1">
              <label class="text-[10px] text-slate-400 uppercase font-semibold">Seed Range</label>
              <span id="val-seedrange" class="text-[10px] text-slate-500 font-mono">2–300</span>
            </div>
            <div class="flex gap-2">
              <input id="cfg-seedmin" type="number" value="2" min="1" class="w-full bg-slate-800 border border-slate-700 text-slate-200 rounded px-2 py-1 text-xs focus:outline-none" />
              <input id="cfg-seedmax" type="number" value="300" min="2" class="w-full bg-slate-800 border border-slate-700 text-slate-200 rounded px-2 py-1 text-xs focus:outline-none" />
            </div>
          </div>
        </div>
      </div>

      <div class="border-t border-slate-800 pt-4">
        <div class="text-xs font-bold uppercase tracking-wider text-slate-400 mb-2">Macros</div>
        <div class="grid grid-cols-2 gap-2">
          <button id="btn-randomize" class="py-2 bg-slate-800 hover:bg-slate-700 text-slate-200 rounded text-xs border border-slate-700">Randomize</button>
          <button id="btn-reset" class="py-2 bg-slate-800 hover:bg-slate-700 text-slate-200 rounded text-xs border border-slate-700">Reset</button>
        </div>
      </div>
    </section>

    <section class="lg:col-span-3 bg-slate-900/40 border border-slate-800 rounded-xl p-4">
      <div class="flex items-center justify-between gap-3 mb-3">
        <div class="text-xs font-bold uppercase tracking-wider text-slate-400">Toolbox (100+)</div>
        <div class="flex items-center gap-2">
          <input id="tool-search" type="text" placeholder="Search tools…" class="w-64 bg-slate-950 border border-slate-700 text-slate-100 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 focus:outline-none" />
          <select id="tool-filter" class="bg-slate-800 text-xs text-slate-200 border border-slate-700 rounded px-2 py-2 focus:outline-none cursor-pointer">
            <option value="all" selected>All</option>
            <option value="motion">Motion</option>
            <option value="zoom">Zoom</option>
            <option value="rotate">Rotate</option>
            <option value="color">Color</option>
            <option value="layout">Layout</option>
            <option value="seed">Seed</option>
            <option value="overlay">Overlay</option>
          </select>
        </div>
      </div>
      <div id="tool-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 max-h-[70vh] overflow-y-auto custom-scrollbar pr-2"></div>

      <div class="mt-4 border-t border-slate-800 pt-4">
        <div class="text-xs font-bold uppercase tracking-wider text-slate-400 mb-2">Preview</div>
        <div class="aspect-video w-full overflow-hidden rounded-xl border border-slate-800 bg-slate-950">
          <iframe id="preview-frame" src="../simulations/fractal-sim.html" class="w-full h-full"></iframe>
        </div>
        <div class="mt-2 text-[10px] text-slate-500 font-mono">Preview starts/stops the screensaver inside the iframe.</div>
      </div>
    </section>
  </main>

  <script>
    const SCREENSAVER_KEY = 'fractalScreensaverConfigV1';
    const $ = (id) => document.getElementById(id);

    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
    function lerp(a, b, t) { return a + (b - a) * t; }
    function debounce(fn, ms) {
      let t = null;
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    }

    function defaultConfig() {
      return {
        enabled: true,
        timeScale: 1,
        panAmp: 2,
        panSpeed: 1,
        zoomBase: 0.15,
        zoomAmp: 0.05,
        zoomSpeed: 0.5,
        rotDegPerSec: 0,
        cycleTheme: false,
        cycleLayout: false,
        cycleSeed: false,
        periodSec: 8,
        seedMin: 2,
        seedMax: 300,
        overlays: { grid: null, lines: null, primes: null, leaf: null, mandelbrot: null, particles: null, force: null, gol: null },
        motion: { panWaveX: 'sin', panWaveY: 'cos', zoomWave: 'sin', jitter: 0, wander: 0 },
        pools: {
          themes: ['default','ocean','magma','mono','heatmap','tau','phi','omega','abundance','modulo','custom','circuit'],
          layouts: ['radial','tree','v-tree','vertical','binary','hex','diamond','zigzag','lattice','logspiral','wavefront','gridwarp','hexwarp','dna']
        }
      };
    }

    let cfg = null;
    function loadCfg() {
      try {
        const raw = localStorage.getItem(SCREENSAVER_KEY);
        const obj = raw ? JSON.parse(raw) : null;
        cfg = Object.assign(defaultConfig(), obj || {});
      } catch (e) {
        cfg = defaultConfig();
      }
      return cfg;
    }
    function saveCfg() {
      localStorage.setItem(SCREENSAVER_KEY, JSON.stringify(cfg));
    }

    const ui = {
      enabled: $('cfg-enabled'),
      timeScale: $('cfg-timescale'),
      panAmp: $('cfg-panamp'),
      panSpeed: $('cfg-panspeed'),
      zoomBase: $('cfg-zoombase'),
      zoomAmp: $('cfg-zoomamp'),
      zoomSpeed: $('cfg-zoomspeed'),
      rot: $('cfg-rot'),
      cycleTheme: $('cfg-cycle-theme'),
      cycleLayout: $('cfg-cycle-layout'),
      cycleSeed: $('cfg-cycle-seed'),
      period: $('cfg-period'),
      seedMin: $('cfg-seedmin'),
      seedMax: $('cfg-seedmax'),
      val: {
        timeScale: $('val-timescale'),
        panAmp: $('val-panamp'),
        panSpeed: $('val-panspeed'),
        zoomBase: $('val-zoombase'),
        zoomAmp: $('val-zoomamp'),
        zoomSpeed: $('val-zoomspeed'),
        rot: $('val-rot'),
        period: $('val-period'),
        seedRange: $('val-seedrange'),
      }
    };

    function syncUIFromCfg() {
      ui.enabled.checked = !!cfg.enabled;
      ui.timeScale.value = String(cfg.timeScale ?? 1);
      ui.panAmp.value = String(cfg.panAmp ?? 2);
      ui.panSpeed.value = String(cfg.panSpeed ?? 1);
      ui.zoomBase.value = String(cfg.zoomBase ?? 0.15);
      ui.zoomAmp.value = String(cfg.zoomAmp ?? 0.05);
      ui.zoomSpeed.value = String(cfg.zoomSpeed ?? 0.5);
      ui.rot.value = String(cfg.rotDegPerSec ?? 0);
      ui.cycleTheme.checked = !!cfg.cycleTheme;
      ui.cycleLayout.checked = !!cfg.cycleLayout;
      ui.cycleSeed.checked = !!cfg.cycleSeed;
      ui.period.value = String(cfg.periodSec ?? 8);
      ui.seedMin.value = String(cfg.seedMin ?? 2);
      ui.seedMax.value = String(cfg.seedMax ?? 300);

      ui.val.timeScale.textContent = `${Number(ui.timeScale.value).toFixed(2)}x`;
      ui.val.panAmp.textContent = Number(ui.panAmp.value).toFixed(1);
      ui.val.panSpeed.textContent = Number(ui.panSpeed.value).toFixed(2);
      ui.val.zoomBase.textContent = Number(ui.zoomBase.value).toFixed(3);
      ui.val.zoomAmp.textContent = Number(ui.zoomAmp.value).toFixed(3);
      ui.val.zoomSpeed.textContent = Number(ui.zoomSpeed.value).toFixed(2);
      ui.val.rot.textContent = Number(ui.rot.value).toFixed(1);
      ui.val.period.textContent = String(parseInt(ui.period.value) || 8);
      ui.val.seedRange.textContent = `${ui.seedMin.value}–${ui.seedMax.value}`;
    }

    function readCfgFromUI() {
      cfg.enabled = !!ui.enabled.checked;
      cfg.timeScale = Number(ui.timeScale.value);
      cfg.panAmp = Number(ui.panAmp.value);
      cfg.panSpeed = Number(ui.panSpeed.value);
      cfg.zoomBase = Number(ui.zoomBase.value);
      cfg.zoomAmp = Number(ui.zoomAmp.value);
      cfg.zoomSpeed = Number(ui.zoomSpeed.value);
      cfg.rotDegPerSec = Number(ui.rot.value);
      cfg.cycleTheme = !!ui.cycleTheme.checked;
      cfg.cycleLayout = !!ui.cycleLayout.checked;
      cfg.cycleSeed = !!ui.cycleSeed.checked;
      cfg.periodSec = Number(ui.period.value);
      cfg.seedMin = parseInt(ui.seedMin.value) || 2;
      cfg.seedMax = parseInt(ui.seedMax.value) || 300;
      saveCfg();
      syncUIFromCfg();
    }

    function randomize() {
      cfg.enabled = true;
      cfg.timeScale = lerp(0.6, 1.6, Math.random());
      cfg.panAmp = lerp(0, 18, Math.random());
      cfg.panSpeed = lerp(0.1, 3.5, Math.random());
      cfg.zoomBase = lerp(0.03, 0.35, Math.random());
      cfg.zoomAmp = lerp(0.0, 0.18, Math.random());
      cfg.zoomSpeed = lerp(0.1, 1.6, Math.random());
      cfg.rotDegPerSec = lerp(-18, 18, Math.random());
      cfg.cycleTheme = Math.random() < 0.6;
      cfg.cycleLayout = Math.random() < 0.4;
      cfg.cycleSeed = Math.random() < 0.6;
      cfg.periodSec = Math.round(lerp(3, 18, Math.random()));
      cfg.seedMin = Math.round(lerp(2, 30, Math.random()));
      cfg.seedMax = Math.round(lerp(120, 1200, Math.random()));
      const waves = ['sin','cos','tri'];
      cfg.motion.panWaveX = waves[Math.floor(Math.random() * waves.length)];
      cfg.motion.panWaveY = waves[Math.floor(Math.random() * waves.length)];
      cfg.motion.zoomWave = waves[Math.floor(Math.random() * waves.length)];
      cfg.motion.jitter = Math.random() < 0.5 ? 0 : lerp(0.2, 2.5, Math.random());
      saveCfg();
      syncUIFromCfg();
    }

    function downloadJson(name, obj) {
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name;
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 500);
    }

    // 100+ tool generator
    const TOOLS = (() => {
      const tools = [];
      const add = (group, name, desc, apply) => tools.push({ id: `${group}:${name}`.replace(/\\s+/g,'_').toLowerCase(), group, name, desc, apply });

      const waves = [
        { w: 'sin', label: 'Sine' },
        { w: 'cos', label: 'Cosine' },
        { w: 'tri', label: 'Triangle' },
      ];

      // Motion tools: 3*3*5 = 45
      const panPresets = [
        { amp: 0, spd: 1.0 },
        { amp: 1.5, spd: 0.6 },
        { amp: 3, spd: 0.9 },
        { amp: 6, spd: 1.2 },
        { amp: 12, spd: 2.0 },
      ];
      waves.forEach(wx => waves.forEach(wy => panPresets.forEach(p => {
        add('motion', `Pan ${wx.label}/${wy.label} ${p.amp}×${p.spd}`, `Pan LFO ${wx.label}/${wy.label}`, (c) => {
          c.panAmp = p.amp;
          c.panSpeed = p.spd;
          c.motion.panWaveX = wx.w;
          c.motion.panWaveY = wy.w;
        });
      })));

      // Zoom tools: 3*5*5*4 = 300
      const zoomBases = [0.03, 0.06, 0.1, 0.18, 0.28];
      const zoomAmps = [0.0, 0.02, 0.05, 0.10, 0.16];
      const zoomSpeeds = [0.12, 0.25, 0.5, 1.0];
      waves.forEach(zw => zoomBases.forEach(b => zoomAmps.forEach(a => zoomSpeeds.forEach(s => {
        add('zoom', `Zoom ${zw.label} b${b} a${a} s${s}`, `Zoom wave ${zw.label}`, (c) => {
          c.zoomBase = b;
          c.zoomAmp = a;
          c.zoomSpeed = s;
          c.motion.zoomWave = zw.w;
        });
      }))));

      // Rotate tools: 11
      [-60,-30,-12,-6,-3,0,3,6,12,30,60].forEach(r => add('rotate', `Rotate ${r}°/s`, `Spin at ${r}°/s`, (c) => { c.rotDegPerSec = r; }));

      // Themes: 16 + cycle
      const themeTools = [
        ['default','Rainbow'],['ocean','Oceanic'],['magma','Magma'],['mono','Blueprint'],
        ['heatmap','Heatmap'],['tau','Divisors τ(n)'],['sigma','Sum σ(n)'],['phi','Totient φ(n)'],
        ['mobius','Möbius μ(n)'],['omega','Distinct Ω(n)'],['bigomega','Total ω(n)'],['squarefree','Squarefree'],
        ['abundance','Abundant/Deficient'],['modulo','Modulo'],['custom','Custom Gradient'],['circuit','Circuit']
      ];
      themeTools.forEach(([id,label]) => add('color', `Theme: ${label}`, `Set theme to ${label}`, (c) => { c.cycleTheme = false; }));
      add('color', 'Cycle themes (fast)', 'Cycle themes quickly', (c) => { c.cycleTheme = true; c.periodSec = 3; });
      add('color', 'Cycle themes (slow)', 'Cycle themes slowly', (c) => { c.cycleTheme = true; c.periodSec = 12; });

      // Layout + cycling
      (defaultConfig().pools.layouts || []).forEach(l => add('layout', `Layout: ${l}`, `Set layout to ${l}`, (c) => { c.cycleLayout = false; }));
      add('layout', 'Cycle layouts (fast)', 'Cycle layouts quickly', (c) => { c.cycleLayout = true; c.periodSec = 4; });
      add('layout', 'Cycle layouts (slow)', 'Cycle layouts slowly', (c) => { c.cycleLayout = true; c.periodSec = 16; });

      // Seed cycling presets: 5 ranges * 4 periods = 20
      const ranges = [[2,120],[2,300],[10,800],[100,5000],[2,15000]];
      ranges.forEach(([a,b]) => [3,6,10,16].forEach(p => add('seed', `Seeds ${a}–${b} / ${p}s`, `Cycle seeds in ${a}–${b}`, (c) => {
        c.cycleSeed = true; c.seedMin = a; c.seedMax = b; c.periodSec = p;
      })));
      add('seed', 'Use current seed (no cycling)', 'Disable seed cycling', (c) => { c.cycleSeed = false; });

      // Overlay overrides: 8 toggles * 3 = 24
      const toggles = [
        ['grid','Grid'],['lines','Lines'],['primes','Highlight primes'],['leaf','Leaf styling'],
        ['mandelbrot','Mandelbrot BG'],['particles','Particles'],['force','Physics'],['gol','Game of Life']
      ];
      toggles.forEach(([k,label]) => {
        add('overlay', `Force ${label} ON`, `Force ${label} on`, (c) => { c.overlays[k] = true; });
        add('overlay', `Force ${label} OFF`, `Force ${label} off`, (c) => { c.overlays[k] = false; });
        add('overlay', `Release ${label}`, `Stop overriding ${label}`, (c) => { c.overlays[k] = null; });
      });

      // Jitter: 6
      [0,0.25,0.5,1,2.5,5].forEach(j => add('motion', `Jitter ${j}`, `Pan jitter`, (c) => { c.motion.jitter = j; }));

      return tools;
    })();

    const toolGrid = $('tool-grid');
    const toolSearch = $('tool-search');
    const toolFilter = $('tool-filter');

    function renderTools() {
      const q = (toolSearch.value || '').trim().toLowerCase();
      const f = toolFilter.value || 'all';
      const list = TOOLS.filter(t => (f === 'all' || t.group === f) && (!q || t.name.toLowerCase().includes(q) || (t.desc || '').toLowerCase().includes(q)));
      toolGrid.innerHTML = '';
      if (list.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'text-sm text-slate-400';
        empty.textContent = 'No tools match.';
        toolGrid.appendChild(empty);
        return;
      }
      list.forEach(t => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'p-3 bg-slate-950/40 hover:bg-slate-800/60 border border-slate-800 rounded-xl text-left transition-colors';
        btn.innerHTML = `
          <div class="text-xs font-bold text-slate-200">${t.name}</div>
          <div class="text-[10px] text-slate-500 mt-1">${t.group.toUpperCase()} • ${(t.desc || '').replace(/</g,'&lt;')}</div>
        `;
        btn.onclick = () => {
          t.apply(cfg);
          saveCfg();
          syncUIFromCfg();
          // if preview running, let it pick up new cfg automatically
        };
        toolGrid.appendChild(btn);
      });
    }

    // Preview control (iframe)
    const frame = $('preview-frame');
    function clickInFrame(id) {
      try {
        const doc = frame.contentWindow.document;
        const el = doc.getElementById(id);
        if (el) el.click();
      } catch (e) {}
    }
    function callInFrame(fnName) {
      try {
        const w = frame.contentWindow;
        if (w && typeof w[fnName] === 'function') { w[fnName](); return true; }
      } catch (e) {}
      return false;
    }

    $('btn-preview').addEventListener('click', () => {
      readCfgFromUI();
      if (!callInFrame('startScreensaver')) clickInFrame('btn-screensaver');
    });
    $('btn-stop').addEventListener('click', () => {
      if (!callInFrame('stopScreensaver')) clickInFrame('btn-screensaver');
    });
    $('btn-reload').addEventListener('click', () => { frame.src = '../simulations/fractal-sim.html'; });
    $('btn-export').addEventListener('click', () => downloadJson('screensaver-config.json', cfg));
    $('btn-randomize').addEventListener('click', () => { randomize(); });
    $('btn-reset').addEventListener('click', () => { cfg = defaultConfig(); saveCfg(); syncUIFromCfg(); });

    $('file-import').addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      try {
        const text = await f.text();
        const obj = JSON.parse(text);
        cfg = Object.assign(defaultConfig(), obj || {});
        saveCfg();
        syncUIFromCfg();
      } catch (err) {
        alert('Invalid JSON.');
      } finally {
        e.target.value = '';
      }
    });

    Object.values(ui).forEach((el) => {
      if (!el || !el.addEventListener) return;
      el.addEventListener('input', debounce(readCfgFromUI, 30));
      el.addEventListener('change', debounce(readCfgFromUI, 30));
    });
    toolSearch.addEventListener('input', debounce(renderTools, 50));
    toolFilter.addEventListener('input', renderTools);

    loadCfg();
    syncUIFromCfg();
    renderTools();
  </script>
</body>
</html>
